(()=>{"use strict";var t,e,a={588:(t,e,a)=>{a.r(e),a.d(e,{executeRunner:()=>A,getAutomationRunner:()=>b,getAvailableRunnerTypes:()=>E,registerAutomationRunner:()=>T});var r=a(81),n=a(705);class s{constructor(){this.isRunning=!1,this.cancelled=!1}createStandardResult(t,e={}){const{result:a=null,summary:r=null,error:n=null}=e;let{status:s}=e;s||(s=t?this.cancelled?"stopped":"completed":"failed");const i={success:t,status:s};return t&&a&&(i.result=a),r?i.summary=r:t&&a&&a.summary&&(i.summary=a.summary),!t&&n&&(i.error=n),this.cancelled&&(i.cancelled=!0),i}async execute(t,e,a){throw new Error("execute() method must be implemented by runner subclasses")}stop(){this.cancelled=!0,this.isRunning=!1}reportProgress(t,e,a){r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_PROGRESS,{currentAction:t,totalActions:e,lastResult:a})}cancel(){this.isRunning&&(this.cancelled=!0)}async executeAction(t,e){try{const a=await(async(t,e)=>{if(!t)throw new Error("No tab ID provided");return new Promise(((a,r)=>{try{chrome.tabs.sendMessage(t,e,(t=>{if(chrome.runtime.lastError){const t=chrome.runtime.lastError.message;r(new Error(t))}else a(t)}))}catch(t){r(t)}}))})(t,{type:"AUTOMATION_ACTION",action:e});return a.success,{action:e,success:a.success,result:a.result,error:a.error}}catch(t){return{action:e,success:!1,error:t.message||"Unknown error"}}}async findElementInHierarchy(t,e){if(!e)return{success:!1,error:"No element data provided"};if(!await n.default.ensureHostPermissionsForTab(t,"scripting"))return{success:!1,error:"Host permissions are required to interact with web pages. Please grant permissions and try again."};try{return(await chrome.scripting.executeScript({target:{tabId:t},func:function(t){if(t.selector)try{if(document.querySelector(t.selector))return{success:!0,method:"selector",element:{found:!0}}}catch(t){}if(t.elementData?.id){if(document.getElementById(t.elementData.id))return{success:!0,method:"id",element:{found:!0}}}if(t.elementData?.xpath)try{if(document.evaluate(t.elementData.xpath,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)return{success:!0,method:"xpath",element:{found:!0}}}catch(t){}if(t.elementData?.hierarchyData&&t.elementData.hierarchyData.length>0){const e=t.elementData.hierarchyData,a=e[0];let r=Array.from(document.getElementsByTagName(a.tagName));if(0===r.length)return{success:!1,error:"No elements with matching tag found"};const n=r.map((t=>{let r=0;if(a.id&&t.id===a.id&&(r+=10),a.classes&&a.classes.length>0){const e=a.classes.filter((e=>t.classList&&t.classList.contains(e)));r+=e.length/a.classes.length*5}if(a.position){Math.abs(t.offsetTop-a.position.offsetTop)<50&&Math.abs(t.offsetLeft-a.position.offsetLeft)<50&&Math.abs(t.offsetWidth-a.position.offsetWidth)<50&&Math.abs(t.offsetHeight-a.position.offsetHeight)<50&&(r+=3)}if(a.innerText&&t.innerText){const e=((t,e)=>{if(!t||!e)return 0;if((t=t.toLowerCase())===(e=e.toLowerCase()))return 1;if(t.includes(e)||e.includes(t))return.8;const a=t.length,r=e.length,n=Array(a+1).fill().map((()=>Array(r+1).fill(0)));for(let t=0;t<=a;t++)n[t][0]=t;for(let t=0;t<=r;t++)n[0][t]=t;for(let s=1;s<=a;s++)for(let a=1;a<=r;a++)t.charAt(s-1)===e.charAt(a-1)?n[s][a]=n[s-1][a-1]:n[s][a]=1+Math.min(n[s-1][a],n[s][a-1],n[s-1][a-1]);return 1-n[a][r]/Math.max(a,r)})(a.innerText.substring(0,100),t.innerText.substring(0,100));r+=4*e}if(a.attributes&&Object.entries(a.attributes).forEach((([e,a])=>{t.getAttribute(e)===a&&(r+=2)})),e.length>1){let a=t,n=0,s=Math.min(3,e.length-1);for(let t=1;t<=s;t++){const r=a.parentElement;if(!r)break;const s=e[t];if(r.tagName===s.tagName&&(n+=1,s.id&&r.id===s.id&&(n+=2),s.classes&&s.classes.length>0)){n+=s.classes.filter((t=>r.classList&&r.classList.contains(t))).length/s.classes.length*1}a=r}r+=n}return{element:t,score:r}}));if(n.sort(((t,e)=>e.score-t.score)),n.length>0&&n[0].score>5)return{success:!0,method:"hierarchy",element:{found:!0,score:n[0].score}}}return{success:!1,error:"Could not reliably find the element using any strategy"}},args:[e]}))[0].result}catch(t){return{success:!1,error:t.message||"Unknown error during element finding"}}}async findAndInteractWithElement(t,e,a="click"){if(!(await this.findElementInHierarchy(t,e)).success)return"click"===a?this.clickElement(t,e.selector):this.executeAction(t,{type:a.toUpperCase(),selector:e.selector});return(await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e){const a=(()=>{if(t.selector)try{const e=document.querySelector(t.selector);if(e)return e}catch(t){}if(t.elementData?.id){const e=document.getElementById(t.elementData.id);if(e)return e}if(t.elementData?.xpath)try{const e=document.evaluate(t.elementData.xpath,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);if(e.singleNodeValue)return e.singleNodeValue}catch(t){}if(t.elementData?.hierarchyData&&t.elementData.hierarchyData.length>0){const e=t.elementData.hierarchyData[0];let a=Array.from(document.getElementsByTagName(e.tagName));if(0===a.length)return null;for(const t of a){if(e.id&&t.id===e.id)return t;if(e.attributes&&e.attributes.class){if(e.attributes.class.split(/\s+/).every((e=>t.classList&&t.classList.contains(e))))return t}}}return null})();if(!a)return{success:!1,error:"Element not found for interaction"};try{switch(e.toLowerCase()){case"click":return a.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout((()=>{try{a.click()}catch(t){try{const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(t)}catch(t){return{success:!1,error:"Failed to click: "+t.message}}}}),300),{success:!0,method:"enhanced-click"};case"scroll":return a.scrollIntoView({behavior:"smooth",block:"center"}),{success:!0,method:"enhanced-scroll"};case"highlight":const t=a.style.outline,r=a.style.backgroundColor;return a.style.outline="2px solid rgba(255, 225, 0, 0.7)",a.style.backgroundColor="rgba(255, 225, 0, 0.2)",setTimeout((()=>{a.style.outline=t,a.style.backgroundColor=r}),2e3),{success:!0,method:"enhanced-highlight"};default:return{success:!1,error:`Unsupported interaction type: ${e}`}}}catch(t){return{success:!1,error:`Interaction error: ${t.message}`}}},args:[e,a]}))[0].result}async clickElement(t,e,a="selector",r={}){const n={enabled:!0,outlineColor:"rgba(255, 225, 0, 0.7)",backgroundColor:"rgba(255, 225, 0, 0.2)",duration:3e3,...r};try{const s=(await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a){const r=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!r)return{success:!1,error:"Element not found"};const n=r.getBoundingClientRect();if(0===n.width||0===n.height)return{success:!1,error:"Element has zero dimensions"};if(!(n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth))return r.scrollIntoView({behavior:"smooth",block:"center"}),{success:"scroll",message:"Element scrolled into view"};const s=r.style.outline,i=r.style.backgroundColor;a.enabled&&(r.style.outline=`2px solid ${a.outlineColor}`,r.style.backgroundColor=a.backgroundColor);const o=()=>{a.enabled&&(r.style.outline=s,r.style.backgroundColor=i)};try{return r.click(),a.enabled&&setTimeout(o,a.duration),{success:!0}}catch(t){try{const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});return r.dispatchEvent(t),a.enabled&&setTimeout(o,a.duration),{success:!0,method:"event"}}catch(t){return o(),{success:!1,error:"Failed to click element: "+t.message}}}},args:[e,a,n]}))[0].result;return"scroll"===s.success?(await this.delay(1e3),this.clickElement(t,e,a,r)):s}catch(t){return{success:!1,error:t.message}}}async clickElementRobust(t,e,a="selector",r={}){const n={maxRetries:3,retryDelay:1e3,humanLike:!0,waitForStability:!0,stabilityWaitTime:500,highlight:{enabled:!0,outlineColor:"rgba(255, 225, 0, 0.7)",backgroundColor:"rgba(255, 225, 0, 0.2)",duration:2e3},...r};for(let r=1;r<=n.maxRetries;r++)try{const s=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a,r){const n=t=>{const e=.3*t;return t+2*(Math.random()-.5)*e},s=t=>new Promise((e=>{const r=t.getBoundingClientRect(),s=r.left+r.width/2+10*(Math.random()-.5),i=r.top+r.height/2+10*(Math.random()-.5);a.humanLike&&(t=>{const e=t.getBoundingClientRect();["mouseover","mouseenter","mousemove"].forEach(((a,r)=>{setTimeout((()=>{const r=new MouseEvent(a,{view:window,bubbles:!0,cancelable:!0,clientX:e.left+e.width/2+10*(Math.random()-.5),clientY:e.top+e.height/2+10*(Math.random()-.5)});t.dispatchEvent(r)}),r*n(50))}))})(t),setTimeout((()=>{const a=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,clientX:s,clientY:i,button:0}),r=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0,clientX:s,clientY:i,button:0}),o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,clientX:s,clientY:i,button:0});t.dispatchEvent(a),setTimeout((()=>{t.dispatchEvent(r),setTimeout((()=>{t.dispatchEvent(o),e({success:!0,method:"human-like"})}),n(20))}),n(30))}),a.humanLike?n(150):0)})),i=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!i)return{success:!1,error:"Element not found",retry:!0};if(!(t=>{const e=t.getBoundingClientRect(),a=window.getComputedStyle(t);if(0===e.width||0===e.height)return!1;if("none"===a.display||"hidden"===a.visibility)return!1;if("0"===a.opacity)return!1;if(t.disabled||t.hasAttribute("disabled"))return!1;if(t.classList.contains("disabled"))return!1;const r=e.left+e.width/2,n=e.top+e.height/2,s=document.elementFromPoint(r,n);if(s&&s!==t&&!t.contains(s)){return"none"===window.getComputedStyle(s).pointerEvents}return!0})(i))return{success:!1,error:"Element is not clickable",retry:!0};const o=i.getBoundingClientRect();if(!(o.top>=0&&o.left>=0&&o.bottom<=window.innerHeight&&o.right<=window.innerWidth))return i.scrollIntoView({behavior:"smooth",block:"center"}),{success:"scroll",message:"Element scrolled into view"};const c=i.style.outline,l=i.style.backgroundColor;a.highlight.enabled&&(i.style.outline=`2px solid ${a.highlight.outlineColor}`,i.style.backgroundColor=a.highlight.backgroundColor);const u=()=>{a.highlight.enabled&&(i.style.outline=c,i.style.backgroundColor=l)},d=a.waitForStability?((t,e=500)=>new Promise((a=>{let r=t.getBoundingClientRect(),n=0;const s=Math.floor(e/50),i=()=>{const e=t.getBoundingClientRect();Math.abs(e.top-r.top)>1||Math.abs(e.left-r.left)>1||Math.abs(e.width-r.width)>1||Math.abs(e.height-r.height)>1?(n=0,r=e):n++,n>=s?a(!0):setTimeout(i,50)};setTimeout(i,50)})))(i,a.stabilityWaitTime):Promise.resolve();return d.then((()=>{try{return i.click(),a.highlight.enabled&&setTimeout(u,a.highlight.duration),{success:!0,method:"direct"}}catch(t){return s(i).then((t=>(a.highlight.enabled&&setTimeout(u,a.highlight.duration),t))).catch((e=>(u(),{success:!1,error:`Both direct and human-like clicks failed: ${t.message}, ${e.message}`,retry:!0})))}})).catch((t=>(u(),{success:!1,error:`Element stability check failed: ${t.message}`,retry:!0})))},args:[e,a,n,r]}),i=s[0].result;if("scroll"===i.success){await this.delay(n.humanLike?this.randomDelay(800,1200):1e3);continue}if(i.success)return i;if(i.retry&&r<n.maxRetries){const t=n.humanLike?this.randomDelay(.8*n.retryDelay,1.5*n.retryDelay):n.retryDelay;await this.delay(t);continue}return i}catch(t){if(r===n.maxRetries)return{success:!1,error:t.message};await this.delay(n.retryDelay)}return{success:!1,error:"All click attempts failed"}}randomDelay(t,e){return Math.floor(Math.random()*(e-t+1))+t}async waitUntilUrlChanges(t,e,a,r){const n=Date.now();for(;Date.now()-n<a;){if(this.cancelled)return!1;if(await this.getCurrentUrl(t)!==e)return!0;await this.delay(r)}return!1}async executeScrollByRows(t,e){const{parentSelector:a,selectorType:r="selector",scrollDelay:n=100,scrollCallback:s=null,startIndex:i=0,childHash:o=null,highlightColor:c="rgba(255, 225, 0, 0.3)"}=e;try{const e=(await chrome.scripting.executeScript({target:{tabId:t},func:(t,e,a)=>{const r=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!r)return{success:!1,error:"Container not found"};const n=(t,e)=>{const a=t.innerText||"",r=t.id||"",n=t.className||"",s=t.tagName||"",i=t.getBoundingClientRect(),o=`${Math.round(i.width)}x${Math.round(i.height)}:${e}`;let c="";for(const e of t.attributes)c+=`${e.name}="${e.value}" `;let l="";if(t.children.length>0){const e=Math.min(3,t.children.length);for(let a=0;a<e;a++){const e=t.children[a];l+=`${e.tagName}:${e.className}:`}}const u=`${s}#${r}.${n}[${o}][${c}][${l}]${a.substring(0,100)}`;let d=0;for(let t=0;t<u.length;t++)d=(d<<5)-d+u.charCodeAt(t),d|=0;return{hash:d.toString(),contextData:{index:e,tagName:s,id:r,className:n,attributes:c,dimensions:{width:Math.round(i.width),height:Math.round(i.height)},childCount:t.children.length,textLength:a.length,firstFewChars:a.substring(0,30)}}},s=Array.from(r.children);let i=-1,o="none";if(a)try{let t;try{t=JSON.parse(a)}catch(e){t={hash:a}}const e=t.hash,r=t.contextData;for(let t=0;t<s.length;t++){if(n(s[t],t).hash===e){i=t,o="high";break}}if(-1===i&&r){const t=s.map(((t,e)=>{const a=n(t,e).contextData;let s=0;a.tagName===r.tagName&&(s+=10),a.id&&a.id===r.id&&(s+=20),a.className===r.className&&(s+=15);const i=Math.abs(a.dimensions.width-r.dimensions.width),o=Math.abs(a.dimensions.height-r.dimensions.height);return i<5&&o<5&&(s+=10),Math.abs(a.childCount-r.childCount)<2&&(s+=5),Math.abs(a.textLength-r.textLength)<20&&(s+=5),a.firstFewChars&&r.firstFewChars&&a.firstFewChars.includes(r.firstFewChars.substring(0,10))&&(s+=10),{index:e,score:s}}));t.sort(((t,e)=>e.score-t.score)),t.length>0&&t[0].score>=30&&(i=t[0].index,o=t[0].score>=50?"medium":"low")}}catch(t){}return{success:!0,childCount:s.length,hashMatchIndex:i,matchConfidence:o,children:s.map(((t,e)=>({index:e,hashData:n(t,e),visible:t.getBoundingClientRect().top>=0&&t.getBoundingClientRect().bottom<=window.innerHeight})))}},args:[a,r,o]}))[0].result;if(!e.success)return{success:!1,error:e.error};if(0===e.childCount)return{success:!0,result:{totalScrolls:0,finalItemCount:0,reachedBottom:!0,currentIndex:0,lastChildHash:null}};let l=i;o&&e.hashMatchIndex>=0&&(l=Math.min(i,e.hashMatchIndex));const u=e.childCount;l>=u&&(l=0);const d=async e=>(await chrome.scripting.executeScript({target:{tabId:t},func:(t,e,a,r)=>{const n=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!n)return{success:!1,error:"Container not found"};if(a>=n.children.length)return{success:!1,error:"Child index out of bounds",reachedBottom:!0};const s=n.children[a],i=((t,e)=>{const a=t.innerText||"",r=t.id||"",n=t.className||"",s=t.tagName||"",i=t.getBoundingClientRect(),o=`${Math.round(i.width)}x${Math.round(i.height)}:${e}`;let c="";for(const e of t.attributes)c+=`${e.name}="${e.value}" `;let l="";if(t.children.length>0){const e=Math.min(3,t.children.length);for(let a=0;a<e;a++){const e=t.children[a];l+=`${e.tagName}:${e.className}:`}}const u=`${s}#${r}.${n}[${o}][${c}][${l}]${a.substring(0,100)}`;let d=0;for(let t=0;t<u.length;t++)d=(d<<5)-d+u.charCodeAt(t),d|=0;return{hash:d.toString(),contextData:{index:e,tagName:s,id:r,className:n,attributes:c,dimensions:{width:Math.round(i.width),height:Math.round(i.height)},childCount:t.children.length,textLength:a.length,firstFewChars:a.substring(0,30)}}})(s,a);s.scrollIntoView({behavior:"auto",block:"center"});return(()=>{const t=document.getElementById("automation-highlight");t&&t.remove();const e=s.getBoundingClientRect(),i=document.createElement("div");i.id="automation-highlight",i.style.position="fixed",i.style.left=`${e.left}px`,i.style.top=`${e.top}px`,i.style.width=`${e.width}px`,i.style.height=`${e.height}px`,i.style.backgroundColor=r,i.style.zIndex="10000",i.style.pointerEvents="none",i.style.transition="opacity 0.3s ease-in-out",i.style.opacity="1",i.style.border="2px solid rgba(255, 225, 0, 0.7)",i.style.borderRadius="4px";const o=document.createElement("div");o.style.position="absolute",o.style.top="2px",o.style.left="2px",o.style.background="rgba(0, 0, 0, 0.7)",o.style.color="white",o.style.padding="2px 6px",o.style.borderRadius="3px",o.style.fontSize="12px",o.textContent=`#${a+1}/${n.children.length}`,i.appendChild(o),document.body.appendChild(i)})(),{success:!0,scrolledToIndex:a,reachedBottom:a>=n.children.length-1,itemCount:n.children.length,childHashData:i,childInfo:{tagName:s.tagName,id:s.id,className:s.className,position:{top:Math.round(s.getBoundingClientRect().top),left:Math.round(s.getBoundingClientRect().left),width:Math.round(s.getBoundingClientRect().width),height:Math.round(s.getBoundingClientRect().height)},text:s.innerText?s.innerText.substring(0,50):""}}},args:[a,r,e,c]}))[0].result;let h=null,m=null;for(;l<u&&!this.cancelled;){const t=await d(l);if(!t.success){if(t.reachedBottom)break;return{success:!1,error:t.error}}if(h=t.childHashData,m=t.childInfo,"function"==typeof s&&await s({...t,currentIndex:l,lastChildHashData:h}),t.reachedBottom)break;l++,n>0&&await this.delay(n)}return await chrome.scripting.executeScript({target:{tabId:t},func:()=>{const t=document.getElementById("automation-highlight");t&&t.remove()}}),{success:!0,result:{finalItemCount:u,reachedBottom:l>=u-1,currentIndex:l,lastChildHashData:h,lastChildInfo:m}}}catch(t){return{success:!1,error:t.message}}}async highlightElement(t,e){const{selector:a,selectorType:r="selector",duration:n=2e3,color:s="rgba(255, 225, 0, 0.3)"}=e;return(await chrome.scripting.executeScript({target:{tabId:t},func:(t,e,a,r)=>{const n=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!n)throw new Error(`Element not found with ${e}: ${t}`);const s=n.getBoundingClientRect(),i=document.createElement("div");return i.style.position="fixed",i.style.left=`${s.left}px`,i.style.top=`${s.top}px`,i.style.width=`${s.width}px`,i.style.height=`${s.height}px`,i.style.backgroundColor=r,i.style.zIndex="10000",i.style.pointerEvents="none",i.style.transition="opacity 0.3s ease-in-out",i.style.opacity="1",i.style.borderRadius="4px",document.body.appendChild(i),setTimeout((()=>{i.style.opacity="0",setTimeout((()=>{document.body.removeChild(i)}),300)}),a),{highlighted:!0,element:{tagName:n.tagName,id:n.id,className:n.className}}},args:[a,r,n,s]}))[0].result}async highlightChildren(t,e){const{selector:a,selectorType:r="selector",duration:n=2e3,color:s="rgba(255, 225, 0, 0.3)"}=e;return(await chrome.scripting.executeScript({target:{tabId:t},func:(t,e,a,r)=>{const n=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!n)throw new Error(`Parent element not found with ${e}: ${t}`);const s=Array.from(n.children);if(0===s.length)return{highlighted:!1,error:"No children found to highlight"};const i=s.map(((t,e)=>{const a=t.getBoundingClientRect(),n=document.createElement("div");n.style.position="fixed",n.style.left=`${a.left}px`,n.style.top=`${a.top}px`,n.style.width=`${a.width}px`,n.style.height=`${a.height}px`,n.style.backgroundColor=r,n.style.zIndex="10000",n.style.pointerEvents="none",n.style.transition="opacity 0.3s ease-in-out",n.style.opacity="1",n.style.border="1px solid rgba(255, 255, 255, 0.3)",n.style.borderRadius="4px";const s=document.createElement("div");return s.style.position="absolute",s.style.top="2px",s.style.left="2px",s.style.background="rgba(0, 0, 0, 0.7)",s.style.color="white",s.style.padding="2px 6px",s.style.borderRadius="3px",s.style.fontSize="12px",s.textContent=`${e+1}`,n.appendChild(s),document.body.appendChild(n),n}));return setTimeout((()=>{i.forEach((t=>{t.style.opacity="0",setTimeout((()=>{document.body.removeChild(t)}),300)}))}),a),{highlighted:!0,count:s.length,elements:s.map((t=>({tagName:t.tagName,id:t.id,className:t.className})))}},args:[a,r,n,s]}))[0].result}async performScroll(t,e){const{direction:a="down",amount:r=500,smooth:n=!0}=e;try{const e=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a){let r={behavior:a?"smooth":"auto"};switch(t.toLowerCase()){case"down":window.scrollBy({top:e,...r});break;case"up":window.scrollBy({top:-e,...r});break;case"left":window.scrollBy({left:-e,...r});break;case"right":window.scrollBy({left:e,...r});break;case"to-top":window.scrollTo({top:0,...r});break;case"to-bottom":window.scrollTo({top:document.body.scrollHeight,...r});break;default:return{success:!1,error:`Invalid scroll direction: ${t}`}}return{success:!0,scrollPosition:{x:window.scrollX,y:window.scrollY}}},args:[a,r,n]});return e[0].result}catch(t){return{success:!1,error:t.message||"Unknown error during scrolling"}}}async scrollElementIntoView(t,e){const{selector:a,selectorType:r="selector",block:n="center",inline:s="nearest",smooth:i=!0}=e;try{return(await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a,r,n){const s=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!s)return{success:!1,error:`Element not found with ${e}: ${t}`};return(()=>{const t=s.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)})()?{success:!0,scrolled:!1,wasAlreadyVisible:!0,elementInfo:{tagName:s.tagName,id:s.id,className:s.className}}:(s.scrollIntoView({behavior:n?"smooth":"auto",block:a,inline:r}),{success:!0,scrolled:!0,wasAlreadyVisible:!1,elementInfo:{tagName:s.tagName,id:s.id,className:s.className,dimensions:{width:s.offsetWidth,height:s.offsetHeight},position:{x:s.getBoundingClientRect().left,y:s.getBoundingClientRect().top}},scrollPosition:{x:window.scrollX,y:window.scrollY}})},args:[a,r,n,s,i]}))[0].result}catch(t){return{success:!1,error:t.message||"Unknown error during scroll element into view operation"}}}async performScrollUntilVisible(t,e){const{selector:a,selectorType:r="selector",direction:n="down",amount:s=300,maxScrolls:i=10,delay:o=100,smooth:c=!0}=e;try{const e=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a,r,n,s,i){return new Promise((o=>{const c=t=>{const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)},l=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!l)return void o({success:!1,error:`Element not found with ${e}: ${t}`});if(c(l))return void o({success:!0,visible:!0,scrolled:!1,attempts:0,scrollPosition:{x:window.scrollX,y:window.scrollY}});let u=0,d={behavior:i?"smooth":"auto"};const h=()=>{if(c(l)||u>=n){const t=c(l);o({success:!0,visible:t,scrolled:u>0,attempts:u,scrollPosition:{x:window.scrollX,y:window.scrollY},result:t?"success":"timeout"})}else{switch(u++,a.toLowerCase()){case"down":window.scrollBy({top:r,...d});break;case"up":window.scrollBy({top:-r,...d});break;case"left":window.scrollBy({left:-r,...d});break;case"right":window.scrollBy({left:r,...d});break;default:return void o({success:!1,error:`Invalid scroll direction: ${a}`})}setTimeout(h,s)}};h()}))},args:[a,r,n,s,i,o,c]});return e[0].result}catch(t){return{success:!1,error:t.message||"Unknown error during scroll until visible operation"}}}async delay(t){if(!(t<=0))return new Promise((e=>setTimeout(e,t)))}async getCurrentUrl(t){try{return(await chrome.tabs.get(t)).url}catch(e){try{return(await chrome.scripting.executeScript({target:{tabId:t},func:()=>window.location.href}))[0].result}catch(t){return null}}}async findViewBySelectors(t,e){if(!e||!Array.isArray(e)||0===e.length)return{success:!1,error:"No selectors provided or invalid selectors array"};try{const a=await chrome.scripting.executeScript({target:{tabId:t},func:t=>{const e=(t,e)=>{try{let a;if("selector"===t)return a=document.querySelectorAll(e),1===a.length;if("xpath"===t){const t=document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);return null!==t.singleNodeValue&&void 0!==t.singleNodeValue}return!1}catch(t){return!1}};for(let a=0;a<t.length;a++){const{type:r,value:n}=t[a];if(r&&n&&e(r,n))return{success:!0,index:a,type:r,value:n}}return{success:!1,error:"No valid selectors found"}},args:[e]});if(a[0].result.success){a[0].result}return a[0].result}catch(t){return{success:!1,error:t.message||"Unknown error testing selectors"}}}async findClickableElement(t,e,a="clickable element",r={}){const n={requireVisible:!0,requireEnabled:!0,requireInViewport:!1,expectedByteSize:null,...r};try{const r=(await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a){const r=t=>{let e=0;try{const a=(new XMLSerializer).serializeToString(t);e=new Blob([a]).size}catch(t){}return e},n=(t,e)=>{if("selector"===e){const e=document.querySelectorAll(t);return 1===e.length?e[0]:null}if("xpath"===e){const e=document.evaluate(t,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);return 1===e.snapshotLength?e.snapshotItem(0):null}return null},s=(t,e)=>{if(!t)return{valid:!1,reason:"Element not found"};const a=t.getBoundingClientRect(),n=window.getComputedStyle(t);if(e.requireVisible){if(0===a.width||0===a.height)return{valid:!1,reason:"Element has zero dimensions"};if("none"===n.display||"hidden"===n.visibility)return{valid:!1,reason:"Element is hidden"};if("0"===n.opacity)return{valid:!1,reason:"Element is transparent"}}if(e.requireEnabled){if(t.disabled||t.hasAttribute("disabled"))return{valid:!1,reason:"Element is disabled"};if(t.classList.contains("disabled"))return{valid:!1,reason:"Element has disabled class"};if("true"===t.getAttribute("aria-disabled"))return{valid:!1,reason:"Element is aria-disabled"}}if(e.expectedByteSize){const a=r(t);if(a!==e.expectedByteSize)return{valid:!1,reason:`Element bytesize mismatch: expected ${e.expectedByteSize} bytes, got ${a} bytes`}}const s=t.tagName.toLowerCase(),i="button"===s||"a"===s||"button"===t.role||"button"===t.getAttribute("role"),o=null!==t.onclick||t.getAttribute("onclick")||t.classList.contains("btn")||t.classList.contains("button");return{valid:!0,confidence:i||o?"high":"medium",elementInfo:{tagName:t.tagName,id:t.id,className:t.className,text:t.textContent?.trim().substring(0,50)||"",position:{x:Math.round(a.left),y:Math.round(a.top),width:Math.round(a.width),height:Math.round(a.height)},attributes:{disabled:t.disabled,onclick:!!t.onclick,role:t.getAttribute("role"),ariaLabel:t.getAttribute("aria-label")},byteSize:e.expectedByteSize?r(t):void 0}}},i=[];for(let a=0;a<t.length;a++){const{type:r,value:o}=t[a];if(r&&o)try{let t=0;if("selector"===r)t=document.querySelectorAll(o).length;else if("xpath"===r){t=document.evaluate(o,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotLength}if(0===t){i.push(`Selector ${a} (${r}): No elements found`);continue}if(t>1){i.push(`Selector ${a} (${r}): Found ${t} elements, expected exactly 1`);continue}const c=s(n(o,r),e);if(c.valid)return{success:!0,index:a,selector:o,selectorType:r,confidence:c.confidence,elementInfo:c.elementInfo};i.push(`Selector ${a} (${r}): Failed validation - ${c.reason}`)}catch(t){i.push(`Selector ${a} (${r}): Error - ${t.message}`)}else i.push(`Selector ${a}: Invalid selector config (missing type or value)`)}return{success:!1,error:`No valid ${a} found after testing ${t.length} selectors`,failureReasons:i}},args:[e,n,a]}))[0].result;if(r.success){n.expectedByteSize&&r.elementInfo.byteSize}else if(r.failureReasons&&r.failureReasons.length<=3);else if(r.failureReasons&&r.failureReasons.length>3){const t={};r.failureReasons.forEach((e=>{const a=e.split(": ")[1]||e;t[a]=(t[a]||0)+1}))}return r}catch(t){return{success:!1,error:t.message||`Unknown error finding ${a}`}}}async clickElementSimple(t,e,a="selector",r={}){const n={maxRetries:3,retryDelay:1500,clickHoldTime:{min:100,max:200},highlight:{enabled:!0,outlineColor:"rgba(0, 255, 0, 0.8)",backgroundColor:"rgba(0, 255, 0, 0.1)",duration:1500},...r};for(let r=1;r<=n.maxRetries;r++)try{const s=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a,r){const n=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase()){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!n)return{success:!1,error:"Element not found",retry:!0};const s=n.getBoundingClientRect();if(s.width<=0||s.height<=0)return{success:!1,error:"Element has no size",retry:!0};let i=!1;if(!(s.top>-100&&s.top<window.innerHeight+100&&s.left>-100&&s.left<window.innerWidth+100))try{n.scrollIntoView({behavior:"auto",block:"center"}),i=!0}catch(t){}const o=n.style.outline,c=n.style.backgroundColor;a.highlight.enabled&&(n.style.outline=`2px solid ${a.highlight.outlineColor}`,n.style.backgroundColor=a.highlight.backgroundColor);const l=()=>{a.highlight.enabled&&(n.style.outline=o,n.style.backgroundColor=c)},u=()=>new Promise((t=>{const e=n.getBoundingClientRect(),r=e.left+e.width/2+6*(Math.random()-.5),s=e.top+e.height/2+6*(Math.random()-.5),i=a.clickHoldTime.min+Math.random()*(a.clickHoldTime.max-a.clickHoldTime.min);try{const e=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0,clientX:r,clientY:s,button:0});n.dispatchEvent(e),setTimeout((()=>{try{const e=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0,clientX:r,clientY:s,button:0});n.dispatchEvent(e),setTimeout((()=>{try{const e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,clientX:r,clientY:s,button:0});n.dispatchEvent(e),t({success:!0,method:"natural-sequence",holdTime:Math.round(i)})}catch(e){t({success:!1,error:`Click event failed: ${e.message}`})}}),10)}catch(e){t({success:!1,error:`Mouse up failed: ${e.message}`})}}),i)}catch(e){t({success:!1,error:`Mouse down failed: ${e.message}`})}}));return(i?new Promise((t=>{setTimeout((()=>u().then(t)),300)})):u()).then((t=>{if(t.success)return setTimeout(l,a.highlight.duration),t;try{return n.click(),setTimeout(l,a.highlight.duration),{success:!0,method:"direct-fallback"}}catch(e){return l(),{success:!1,error:`Both natural and direct clicks failed: ${t.error} | ${e.message}`,retry:!0}}}))},args:[e,a,n,r]}),i=s[0].result;if(i.success)return i;if(i.retry&&r<n.maxRetries){await this.delay(n.retryDelay);continue}return i}catch(t){if(r===n.maxRetries)return{success:!1,error:t.message};await this.delay(n.retryDelay)}return{success:!1,error:"All natural click attempts failed"}}}function i(t,e,a,r="selector"){const n=(t,e)=>{const a=t.innerText||"",r=t.id||"",n=t.className||"",s=t.tagName||"",i=t.getBoundingClientRect(),o=`${Math.round(i.width)}x${Math.round(i.height)}:${e}`;let c="";for(const e of t.attributes)c+=`${e.name}="${e.value}" `;let l="";if(t.children.length>0){const e=Math.min(3,t.children.length);for(let a=0;a<e;a++){const e=t.children[a];l+=`${e.tagName}:${e.className}:`}}const u=`${s}#${r}.${n}[${o}][${c}][${l}]${a.substring(0,100)}`;let d=0;for(let t=0;t<u.length;t++)d=(d<<5)-d+u.charCodeAt(t),d|=0;return{hash:d.toString(),contextData:{index:e,tagName:s,id:r,className:n,attributes:c,dimensions:{width:Math.round(i.width),height:Math.round(i.height)},childCount:t.children.length,textLength:a.length,firstFewChars:a.substring(0,30)}}},s=t=>{const e=t.innerText||"",a=t.id||"",r=t.className||"",n=(t.tagName||"")+a+r+e.substring(0,100);let s=0;for(let t=0;t<n.length;t++)s=(s<<5)-s+n.charCodeAt(t),s|=0;return s.toString()},i=t=>{if(!t)return"";if("string"!=typeof t)try{t=String(t)}catch(t){return""}if(t.trim().toLowerCase().startsWith("javascript:"))return"";if(t.startsWith("http://")||t.startsWith("https://"))return t;if(t.startsWith("//"))return`${window.location.protocol}${t}`;const{protocol:e,host:a,pathname:r}=window.location,n=`${e}//${a}`;if(t.startsWith("/"))return`${n}${t}`;const s=r.split("/").filter(Boolean);s.pop();return`${n}${s.length>0?`/${s.join("/")}/`:"/"}${t}`},o=(t,e,a)=>{const r=a.backgroundPosition,[n,s]=r.split(" ").map((t=>t.endsWith("%")?0:parseInt(t)));return n<0||s<0||0===n&&s<0||n<0&&0===s||!!t.startsWith("data:")},c=(t,e=[],a={})=>{let r={};if("SCRIPT"===t.tagName||"STYLE"===t.tagName||"NOSCRIPT"===t.tagName)return r;const{id:n}=(t=>{const e=["js-","data-"],a=(t.getAttribute("class")||"").split(/\s+/).filter((t=>t&&!e.some((e=>t.startsWith(e))))),r=a.length>0?a[0]:t.tagName.toLowerCase();let n="";const s=Array.from(t.attributes).filter((t=>t.name.startsWith("data-"))).map((t=>t.name));if(s.length>0&&(n=s[0].replace("data-","")),n||(t.id?n=t.id:t.getAttribute("role")?n=t.getAttribute("role"):t.getAttribute("aria-label")&&(n=t.getAttribute("aria-label"))),!n)if("a"===t.tagName.toLowerCase())n="link";else if("img"===t.tagName.toLowerCase())n="image";else if("button"===t.tagName.toLowerCase())n="button";else if("h1"===t.tagName.toLowerCase()||"h2"===t.tagName.toLowerCase()||"h3"===t.tagName.toLowerCase()||"h4"===t.tagName.toLowerCase())n="heading";else if("p"===t.tagName.toLowerCase())n="paragraph";else if("span"===t.tagName.toLowerCase()&&t.textContent.trim()){const e=t.textContent.trim(),a=/^[\d,]+$/.test(e)||/^[\d,]+\.\d+$/.test(e),r=e.match(/\b(days?|hours?|minutes?|seconds?|weeks?|months?)\b/i);n=a?"numeric_value":r?"time_value":e.length>20?"description":"text_content"}else"div"===t.tagName.toLowerCase()&&(t.querySelector("img")?n="image_container":t.querySelector("a")?n="link_container":t.querySelectorAll("div, span").length>3&&(n="container"));if(!n){const e=(t.getAttribute("class")||"").split(/\s+/).filter(Boolean);n=e.find((t=>!t.includes("__")&&!t.match(/^sc-[a-z0-9]/)&&!t.match(/^[a-z][0-9]/)&&t.length>2))||(e.length>0?e[0]:t.tagName.toLowerCase())}return{id:r,displayLabel:n}})(t);a[n]?a[n]+=1:a[n]=1;const s=[...e,`${n}${a[n]>1?` (${a[n]})`:""}`],l=s.join(" > "),u=Array.from(t.childNodes).filter((t=>t.nodeType===Node.TEXT_NODE)).map((t=>t.textContent.trim())).filter(Boolean).join(" ");if(u&&(r[l]=u),"a"===t.tagName.toLowerCase()){const e=t.getAttribute("href")||"";e&&"string"==typeof e&&!e.trim().toLowerCase().startsWith("javascript:")&&(r[`${l} href`]=i(e.trim()))}if("img"===t.tagName.toLowerCase()){const e=t.getAttribute("src")||"";if(e&&"string"==typeof e){r[`${l} src`]=i(e.trim());const a=t.getBoundingClientRect(),n=t.parentElement?t.parentElement.getBoundingClientRect():{width:0,height:0};r[`${l} src dimensions`]={width:Math.round(a.width),height:Math.round(a.height),area:Math.round(a.width*a.height),parentWidth:Math.round(n.width),parentHeight:Math.round(n.height),parentArea:Math.round(n.width*n.height)}}const a=t.getAttribute("alt")||"";a&&"string"==typeof a&&(r[`${l} alt`]=a.trim())}const d=(t=>{if("VIDEO"===t.tagName&&t.hasAttribute("poster")){const e=t.getAttribute("poster");if(e)return i(e)}const e=window.getComputedStyle(t);let a=e.backgroundImage;if(!a||"none"===a){const e=t.getAttribute("style");if(e){const t=e.match(/background-image:\s*url\(['"']?(.*?)['"']?\)/i);t&&t[1]&&(a=`url("${t[1]}")`)}}if(a&&"none"!==a){const r=a.match(/url\(['"']?(.*?)['"']?\)/i);if(r&&r[1]){const a=r[1];if(a.startsWith("data:"))return null;const n=i(a);return o(n,t,e)?null:n}}return null})(t);if(d){r[`${l} background`]=d;const e=t.getBoundingClientRect(),a=t.parentElement?t.parentElement.getBoundingClientRect():{width:0,height:0};r[`${l} background dimensions`]={width:Math.round(e.width),height:Math.round(e.height),area:Math.round(e.width*e.height),parentWidth:Math.round(a.width),parentHeight:Math.round(a.height),parentArea:Math.round(a.width*a.height)}}const h=Array.from(t.children);if(h.length>0){const t={},e={};for(const a of h){const r=c(a,s,e);Object.assign(t,r)}r={...r,...t}}return r},l=(t,e,a)=>{let r=e,i=null;if(e&&"string"==typeof e)try{const t=JSON.parse(e);t.hash&&(r=t.hash,i=t.contextData)}catch(t){r=e}let o=null,l=-1;if(r)if(i){const e=t.map(((t,e)=>{const a=n(t,e),s=a.contextData;let o=0;if(s.tagName===i.tagName&&(o+=10),s.id&&s.id===i.id&&(o+=20),s.className===i.className&&(o+=15),i.dimensions){const t=Math.abs(s.dimensions.width-i.dimensions.width),e=Math.abs(s.dimensions.height-i.dimensions.height);t<5&&e<5&&(o+=10)}return Math.abs(s.childCount-i.childCount)<2&&(o+=5),Math.abs(s.textLength-i.textLength)<20&&(o+=5),s.firstFewChars&&i.firstFewChars&&s.firstFewChars.includes(i.firstFewChars.substring(0,10))&&(o+=10),a.hash===r&&(o+=50),{element:t,index:e,score:o}}));e.sort(((t,e)=>e.score-t.score)),e.length>0&&e[0].score>=20&&(o=e[0].element,l=e[0].index)}else for(let e=0;e<t.length;e++)if(s(t[e])===r){o=t[e],l=e;break}if(!o&&void 0!==a&&a>=0&&a<t.length&&(o=t[a],l=a),!o)return{success:!1,error:r?`Element with hash ${r} not found`:`Element at index ${a} not found or invalid index`};const u=c(o),d=new Set(Object.keys(u)),h=Array.from(d).map((t=>{let e=t,a="text";e.endsWith(" href")?(e=e.replace(" href"," URL"),a="link"):e.endsWith(" src")?(e=e.replace(" src"," Image"),a="image"):e.endsWith(" alt")?(e=e.replace(" alt"," Description"),a="text"):e.endsWith(" background")&&(e=e.replace(" background"," Background Image"),a="image");const r=e.split(" > ");if(r.length>0){e=r[r.length-1].replace(/^[a-z]+\s+/,"").replace(/\([0-9]+\)$/,"").trim()}if(e.includes("title")||e.includes("heading")?e="Title":e.includes("description")||e.includes("summary")?e="Description":e.includes("price")?(e="Price",a="price"):e.includes("author")?e="Author":e.includes("date")?(e="Date",a="date"):e.includes("rating")?(e="Rating",a="rating"):e.includes("review")?e="Reviews":e.includes("time_value")?(e="Time",a="time"):"link"===e?(e="Link",a="link"):"image"!==e&&"img"!==e||(e="Image",a="image"),"text"===a){const e=u[t];null!=e&&""!==e&&(/^[\d,]+$/.test(e)||/^[\d,]+\.\d+$/.test(e)?a="number":"string"==typeof e&&(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("www."))&&!t.endsWith(" href")&&(a="link"))}(!e||"string"==typeof e&&""===e.trim())&&(e="Column "+(Array.from(d).indexOf(t)+1)),e=e.split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" ");return{id:(t=>{let e=0;for(let a=0;a<t.length;a++)e=(e<<5)-e+t.charCodeAt(a),e|=0;return Math.abs(e).toString(36).slice(0,8)})(t),originalId:t,name:e,type:a}})),m=h.reduce(((t,e)=>(e.originalId&&(t[e.originalId]=e.id),t)),{}),g={};Object.entries(u).forEach((([t,e])=>{g[m[t]]=e}));const p=n(o,l);return{success:!0,item:g,columns:h,elementIndex:l,elementHash:p}};try{const n=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase())return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return null})(t,r);if(!n)return{success:!1,error:"List container not found"};const s=Array.from(n.children);if(0===s.length)return{success:!1,error:"No list items found in container"};if(e||null!=a)return l(s,e,a);{const t=[],e=new Map;for(let a=0;a<s.length;a++){const r=l(s,null,a);r.success&&(t.push(r.item),r.columns.forEach((t=>{e.set(t.id,t)})))}const a=Array.from(e.values()),r=a.filter((t=>!t.originalId.endsWith(" src dimensions")&&!t.originalId.endsWith(" background dimensions")));r.forEach((e=>{if("image"===e.type){const r=e.originalId+" dimensions";let n=0,s=null;t.forEach((t=>{const e=Object.keys(t).find((t=>{const e=a.find((e=>e.id===t));return e&&e.originalId===r}));if(e&&t[e]&&"object"==typeof t[e]){const a=t[e];a.area>n&&(n=a.area,s=a)}})),s&&(e.imageMetadata={maxWidth:s.width,maxHeight:s.height,maxArea:s.area,maxParentWidth:s.parentWidth,maxParentHeight:s.parentHeight,maxParentArea:s.parentArea})}}));const n=r.sort(((t,e)=>{const a="image"===t.type,r="image"===e.type;if(a&&r){const a=t.imageMetadata?.maxArea||0;return(e.imageMetadata?.maxArea||0)-a}return a&&!r?-1:!a&&r?1:0}));return{success:!0,items:t,columns:n}}}catch(t){return{success:!1,error:t.message}}}function o(t,e="selector",a=!0){const r=t=>{if(!t)return"";if("string"!=typeof t)try{t=String(t)}catch(t){return""}if(t.trim().toLowerCase().startsWith("javascript:"))return"";if(t.startsWith("http://")||t.startsWith("https://"))return t;if(t.startsWith("//"))return`${window.location.protocol}${t}`;const{protocol:e,host:a,pathname:r}=window.location,n=`${e}//${a}`;if(t.startsWith("/"))return`${n}${t}`;const s=r.split("/").filter(Boolean);s.pop();return`${n}${s.length>0?`/${s.join("/")}/`:"/"}${t}`},n=t=>{if("VIDEO"===t.tagName&&t.hasAttribute("poster")){const e=t.getAttribute("poster");if(e)return r(e)}const e=window.getComputedStyle(t);let a=e.backgroundImage;if(!a||"none"===a){const e=t.getAttribute("style");if(e){const t=e.match(/background-image:\s*url\(['"']?(.*?)['"']?\)/i);t&&t[1]&&(a=`url("${t[1]}")`)}}if(a&&"none"!==a){const n=a.match(/url\(['"']?(.*?)['"']?\)/i);if(n&&n[1]){const a=n[1];if(a.startsWith("data:"))return null;const i=r(a);return s(i,t,e)?null:i}}return null},s=(t,e,a)=>{const r=a.backgroundPosition,[n,s]=r.split(" ").map((t=>t.endsWith("%")?0:parseInt(t)));return n<0||s<0||0===n&&s<0||n<0&&0===s||!!t.startsWith("data:")},i=(t,e=[],a={})=>{let s={};if("SCRIPT"===t.tagName||"STYLE"===t.tagName||"NOSCRIPT"===t.tagName)return s;const{id:o}=(t=>{const e=["js-","data-"],a=(t.getAttribute("class")||"").split(/\s+/).filter((t=>t&&!e.some((e=>t.startsWith(e))))),r=a.length>0?a[0]:t.tagName.toLowerCase();let n="";const s=Array.from(t.attributes).filter((t=>t.name.startsWith("data-"))).map((t=>t.name));if(s.length>0&&(n=s[0].replace("data-","")),n||(t.id?n=t.id:t.getAttribute("role")?n=t.getAttribute("role"):t.getAttribute("aria-label")&&(n=t.getAttribute("aria-label"))),!n)if("a"===t.tagName.toLowerCase())n="link";else if("img"===t.tagName.toLowerCase())n="image";else if("button"===t.tagName.toLowerCase())n="button";else if("h1"===t.tagName.toLowerCase()||"h2"===t.tagName.toLowerCase()||"h3"===t.tagName.toLowerCase()||"h4"===t.tagName.toLowerCase())n="heading";else if("p"===t.tagName.toLowerCase())n="paragraph";else if("span"===t.tagName.toLowerCase()&&t.textContent.trim()){const e=t.textContent.trim(),a=/^[\d,]+$/.test(e)||/^[\d,]+\.\d+$/.test(e),r=e.match(/\b(days?|hours?|minutes?|seconds?|weeks?|months?)\b/i);n=a?"numeric_value":r?"time_value":e.length>20?"description":"text_content"}else"div"===t.tagName.toLowerCase()&&(t.querySelector("img")?n="image_container":t.querySelector("a")?n="link_container":t.querySelectorAll("div, span").length>3&&(n="container"));if(!n){const e=(t.getAttribute("class")||"").split(/\s+/).filter(Boolean);n=e.find((t=>!t.includes("__")&&!t.match(/^sc-[a-z0-9]/)&&!t.match(/^[a-z][0-9]/)&&t.length>2))||(e.length>0?e[0]:t.tagName.toLowerCase())}return{id:r,displayLabel:n}})(t);a[o]?a[o]+=1:a[o]=1;const c=[...e,`${o}${a[o]>1?` (${a[o]})`:""}`],l=c.join(" > "),u=Array.from(t.childNodes).filter((t=>t.nodeType===Node.TEXT_NODE)).map((t=>t.textContent.trim())).filter(Boolean).join(" ");if(u&&(s[l]=u),"a"===t.tagName.toLowerCase()){const e=t.getAttribute("href")||"";e&&"string"==typeof e&&!e.trim().toLowerCase().startsWith("javascript:")&&(s[`${l} href`]=r(e.trim()))}if("img"===t.tagName.toLowerCase()){const e=t.getAttribute("src")||"";if(e&&"string"==typeof e){s[`${l} src`]=r(e.trim());const a=t.getBoundingClientRect(),n=t.parentElement?t.parentElement.getBoundingClientRect():{width:0,height:0};s[`${l} src dimensions`]={width:Math.round(a.width),height:Math.round(a.height),area:Math.round(a.width*a.height),parentWidth:Math.round(n.width),parentHeight:Math.round(n.height),parentArea:Math.round(n.width*n.height)}}const a=t.getAttribute("alt")||"";a&&"string"==typeof a&&(s[`${l} alt`]=a.trim())}const d=n(t);if(d){s[`${l} background`]=d;const e=t.getBoundingClientRect(),a=t.parentElement?t.parentElement.getBoundingClientRect():{width:0,height:0};s[`${l} background dimensions`]={width:Math.round(e.width),height:Math.round(e.height),area:Math.round(e.width*e.height),parentWidth:Math.round(a.width),parentHeight:Math.round(a.height),parentArea:Math.round(a.width*a.height)}}const h=Array.from(t.children);if(h.length>0){const t={},e={};for(const a of h){const r=i(a,c,e);Object.assign(t,r)}s={...s,...t}}return s};try{const s=((t,e)=>{if("selector"===e.toLowerCase())return document.querySelector(t);if("xpath"===e.toLowerCase())return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return null})(t,e);if(!s)return{success:!1,error:"Target element not found"};const o=i(s);let c=o;if(a){const t={},e=Array.from(s.childNodes).filter((t=>t.nodeType===Node.TEXT_NODE)).map((t=>t.textContent.trim())).filter(Boolean).join(" ");if(e&&(t.text=e),"a"===s.tagName.toLowerCase()){const e=s.getAttribute("href")||"";e&&"string"==typeof e&&!e.trim().toLowerCase().startsWith("javascript:")&&(t.href=r(e.trim()))}if("img"===s.tagName.toLowerCase()){const e=s.getAttribute("src")||"";e&&"string"==typeof e&&(t.src=r(e.trim()));const a=s.getAttribute("alt")||"";a&&"string"==typeof a&&(t.alt=a.trim())}const a=n(s);a&&(t.background=a),s.id&&(t.id=s.id),s.className&&(t.class=s.className),s.getAttribute("title")&&(t.title=s.getAttribute("title")),s.getAttribute("data-value")&&(t["data-value"]=s.getAttribute("data-value")),c={...t,...o}}const l=new Set(Object.keys(c)),u=Array.from(l).map((t=>{let e=t,a="text";e.endsWith(" href")?(e=e.replace(" href"," URL"),a="link"):e.endsWith(" src")?(e=e.replace(" src"," Image"),a="image"):e.endsWith(" alt")?(e=e.replace(" alt"," Description"),a="text"):e.endsWith(" background")&&(e=e.replace(" background"," Background Image"),a="image");const r=e.split(" > ");if(r.length>0){e=r[r.length-1].replace(/^[a-z]+\s+/,"").replace(/\([0-9]+\)$/,"").trim()}if(e.includes("title")||e.includes("heading")?e="Title":e.includes("description")||e.includes("summary")?e="Description":e.includes("price")?(e="Price",a="price"):e.includes("author")?e="Author":e.includes("date")?(e="Date",a="date"):e.includes("rating")?(e="Rating",a="rating"):e.includes("review")?e="Reviews":e.includes("time_value")?(e="Time",a="time"):"link"===e?(e="Link",a="link"):"image"!==e&&"img"!==e||(e="Image",a="image"),"text"===a){const e=c[t];null!=e&&""!==e&&(/^[\d,]+$/.test(e)||/^[\d,]+\.\d+$/.test(e)?a="number":"string"==typeof e&&(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("www."))&&!t.endsWith(" href")&&(a="link"))}(!e||"string"==typeof e&&""===e.trim())&&(e="Column "+(Array.from(l).indexOf(t)+1)),e=e.split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" ");return{id:(t=>{let e=0;for(let a=0;a<t.length;a++)e=(e<<5)-e+t.charCodeAt(a),e|=0;return Math.abs(e).toString(36).slice(0,8)})(t),originalId:t,name:e,type:a}})),d=u.reduce(((t,e)=>(e.originalId&&(t[e.originalId]=e.id),t)),{}),h={};return Object.entries(c).forEach((([t,e])=>{h[d[t]]=e})),{success:!0,item:h,columns:u}}catch(t){return{success:!1,error:t.message}}}var c=a(184);class l{constructor(t,e,a){this.runner=t,this.tabId=e,this.config=a}async processElement(t){const e={elementId:t.id,elementName:t.name,success:!1,error:null,data:null,columns:[]};try{const a=await this.runner.findView(this.tabId,t.selectors,`element "${t.name}"`,this.config);if(!a.success)return e.error=a.error,e;await this.runner.highlightElement(this.tabId,{selector:a.selector,selectorType:a.selectorType,duration:this.config?.elementHighlightDuration||1e3});const r=await this.performAction(t,a);return r.success?(e.success=!0,e.data=r,e.columns=this.extractColumns(t,r)):e.error=r.error,e}catch(t){return e.error=t.message,e}}async performAction(t,e){if("extract"===t.action)return await this.runner.performExtractAction(this.tabId,t,e);if("click"===t.action)return await this.runner.performClickAction(this.tabId,t,e);throw new Error(`Unsupported action: ${t.action}`)}extractColumns(t,e){return e.columns?e.columns.map((e=>({...e,elementId:t.id,elementName:t.name}))):[{id:t.id,originalId:t.id,name:t.name,type:t.type||"text",elementId:t.id,elementName:t.name}]}}class u{constructor(){this.reset()}reset(){this.columns=[],this.item={},this.elementResults=[],this.totalItemCount=0}addElementResult(t){this.elementResults.push({elementId:t.elementId,elementName:t.elementName,success:t.success,error:t.error,result:t.data}),t.success&&t.data?this.addSuccessfulResult(t):this.addFailedResult(t)}addSuccessfulResult(t){const{data:e,columns:a}=t;this.columns.push(...a),e.columns&&e.item?(Object.entries(e.item).forEach((([t,e])=>{this.item[t]=e})),this.totalItemCount+=Object.keys(e.item).length):(this.item[t.elementId]=e.value,this.totalItemCount+=1)}addFailedResult(t){this.columns.push({id:t.elementId,originalId:t.elementId,name:t.elementName,type:"text",elementId:t.elementId,elementName:t.elementName}),this.item[t.elementId]=null}getResult(){return{columns:this.columns,item:this.item,elementResults:this.elementResults,totalItemCount:this.totalItemCount,successfulElements:this.elementResults.filter((t=>t.success)).length,failedElements:this.elementResults.filter((t=>!t.success)).length}}}class d{constructor(t,e,a,r){this.runner=t,this.tabId=e,this.config=a,this.tableDataId=r}createErrorResult(t,e){return{url:t,success:!1,error:e,extractedAt:Date.now(),itemCount:0}}}class h extends d{constructor(t,e,a,r){super(t,e,a,r),this.processor=new l(t,e,a),this.aggregator=new u}async extractElements(t,e){if(!t||!Array.isArray(t)||0===t.length)return this.createEmptyResult(e);this.aggregator.reset();for(const e of t){const t=await this.processor.processElement(e);this.aggregator.addElementResult(t),this.config?.delayBetweenElements>0&&await this.runner.delay(this.config.delayBetweenElements)}const a=this.aggregator.getResult();return this.createSuccessResult(e,a)}createEmptyResult(t){return{url:t,success:!0,extractedAt:Date.now(),itemCount:0,columns:[{id:"url",originalId:"url",name:"PAGE URL",type:"link",elementId:"url",elementName:"Source URL"}],item:{url:t},elementResults:[]}}createSuccessResult(t,e){const a=[{id:"url",originalId:"url",name:"PAGE URL",type:"link",elementId:"url",elementName:"Source URL"},...e.columns],r={url:t,...e.item};return{url:t,success:!0,extractedAt:Date.now(),itemCount:e.totalItemCount,columns:a,item:r,elementResults:e.elementResults}}}class m extends d{async extractElements(t,e){try{const a=await this.runner.extractEmailsFromPage(this.tabId,t,e);return a.success&&a.emails&&a.emails.length>0?this.transformToStandardFormat(a,e):this.createEmptyResult(e,a.error)}catch(t){return this.createErrorResult(e,t.message)}}transformToStandardFormat(t,e){const{emails:a,emailBreakdown:r}=t,n={url:e,emails:a.join(", "),email_count:a.length};return{url:e,success:!0,extractedAt:Date.now(),itemCount:a.length,columns:[{id:"url",originalId:"url",name:"URL",type:"text",elementId:"url",elementName:"Source URL"},{id:"emails",originalId:"emails",name:"Emails",type:"text",elementId:"emails",elementName:"Email Addresses"},{id:"email_count",originalId:"email_count",name:"Email Count",type:"number",elementId:"email_count",elementName:"Number of Emails"}],item:n,originalEmailData:{emails:a,emailBreakdown:r}}}createEmptyResult(t,e=null){const a={url:t,emails:"",email_count:0};return{url:t,success:!e,extractedAt:Date.now(),itemCount:0,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"emails",originalId:"emails",name:"Emails",type:"email",elementId:"emails",elementName:"Email Addresses"},{id:"email_count",originalId:"email_count",name:"Email Count",type:"number",elementId:"email_count",elementName:"Number of Emails"}],item:a,error:e,originalEmailData:{emails:[],emailBreakdown:{}}}}}class g extends d{async extractElements(t,e){try{const a=await this.runner.extractPhonesFromPage(this.tabId,t,e);return a.success&&a.phones&&a.phones.length>0?this.transformToStandardFormat(a,e):this.createEmptyResult(e,a.error)}catch(t){return this.createErrorResult(e,t.message)}}transformToStandardFormat(t,e){const{phones:a}=t,r={url:e,phones:a.join(", "),phone_count:a.length};return{url:e,success:!0,extractedAt:Date.now(),itemCount:a.length,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"phones",originalId:"phones",name:"Phone Numbers",type:"phone",elementId:"phones",elementName:"Phone Numbers"},{id:"phone_count",originalId:"phone_count",name:"Phone Count",type:"number",elementId:"phone_count",elementName:"Number of Phone Numbers"}],item:r,originalPhoneData:{phones:a}}}createEmptyResult(t,e=null){const a={url:t,phones:"",phone_count:0};return{url:t,success:!e,extractedAt:Date.now(),itemCount:0,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"phones",originalId:"phones",name:"Phone Numbers",type:"phone",elementId:"phones",elementName:"Phone Numbers"},{id:"phone_count",originalId:"phone_count",name:"Phone Count",type:"number",elementId:"phone_count",elementName:"Number of Phone Numbers"}],item:a,error:e,originalPhoneData:{phones:[]}}}}class p extends d{async extractElements(t,e){try{const a=await this.runner.extractGoogleMapsFromPage(this.tabId,t,e);return a.success?this.transformToStandardFormat(a,e):this.createEmptyResult(e,a.error)}catch(t){return this.createErrorResult(e,t.message)}}transformToStandardFormat(t,e){const{placeData:a}=t,r={url:e,place_name:a?.name||"",rating:a?.rating||"",rating_count:a?.ratingCount||"",category:a?.category||"",address:a?.address||"",phone:a?.phone||"",website:a?.website||"",hours:a?.hours||"",coordinates:a?.coordinates||"",place_images:a?.images?a.images.join(", "):"",description:a?.description||"",prices:a?.prices?a.prices.join(", "):"",price_level:a?.priceLevel||""};return{url:e,success:!0,extractedAt:Date.now(),itemCount:1,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"place_name",originalId:"place_name",name:"Place Name",type:"text",elementId:"place_name",elementName:"Business/Place Name"},{id:"rating",originalId:"rating",name:"Rating",type:"number",elementId:"rating",elementName:"Average Rating"},{id:"rating_count",originalId:"rating_count",name:"Review Count",type:"number",elementId:"rating_count",elementName:"Number of Reviews"},{id:"category",originalId:"category",name:"Category",type:"text",elementId:"category",elementName:"Business Category"},{id:"address",originalId:"address",name:"Address",type:"text",elementId:"address",elementName:"Full Address"},{id:"phone",originalId:"phone",name:"Phone",type:"phone",elementId:"phone",elementName:"Phone Number"},{id:"website",originalId:"website",name:"Website",type:"link",elementId:"website",elementName:"Website URL"},{id:"hours",originalId:"hours",name:"Hours",type:"text",elementId:"hours",elementName:"Business Hours"},{id:"coordinates",originalId:"coordinates",name:"Coordinates",type:"text",elementId:"coordinates",elementName:"Latitude, Longitude"},{id:"place_images",originalId:"place_images",name:"Place Images",type:"image",elementId:"place_images",elementName:"Image URLs"},{id:"description",originalId:"description",name:"Description",type:"text",elementId:"description",elementName:"Place Description"},{id:"prices",originalId:"prices",name:"Prices",type:"text",elementId:"prices",elementName:"Menu Items & Prices"},{id:"price_level",originalId:"price_level",name:"Price Level",type:"text",elementId:"price_level",elementName:"Price Range"}],item:r,originalPlaceData:a}}createEmptyResult(t,e=null){const a={url:t,place_name:"",rating:"",category:"",address:"",phone:"",website:"",prices:""};return{url:t,success:!e,extractedAt:Date.now(),itemCount:0,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"place_name",originalId:"place_name",name:"Place Name",type:"text",elementId:"place_name",elementName:"Business/Place Name"},{id:"rating",originalId:"rating",name:"Rating",type:"number",elementId:"rating",elementName:"Average Rating"},{id:"category",originalId:"category",name:"Category",type:"text",elementId:"category",elementName:"Business Category"},{id:"address",originalId:"address",name:"Address",type:"text",elementId:"address",elementName:"Full Address"},{id:"phone",originalId:"phone",name:"Phone",type:"phone",elementId:"phone",elementName:"Phone Number"},{id:"website",originalId:"website",name:"Website",type:"link",elementId:"website",elementName:"Website URL"},{id:"prices",originalId:"prices",name:"Prices",type:"text",elementId:"prices",elementName:"Menu Items & Prices"}],item:a,error:e,originalPlaceData:{}}}}class f extends d{async extractElements(t,e){try{const a=await this.runner.extractTextFromPage(this.tabId,t,e);return a.success?this.transformToStandardFormat(a,e):this.createEmptyResult(e,a.error)}catch(t){return this.createErrorResult(e,t.message)}}transformToStandardFormat(t,e){const{title:a,description:r,content:n,wordCount:s,metadata:i}=t,o={url:e,title:a||"",description:r||"",content:n||"",word_count:s||0,author:i?.author||"",publish_date:i?.publishDate||""};return{url:e,success:!0,extractedAt:Date.now(),itemCount:1,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"title",originalId:"title",name:"Title",type:"text",elementId:"title",elementName:"Page Title"},{id:"description",originalId:"description",name:"Description",type:"text",elementId:"description",elementName:"Meta Description"},{id:"content",originalId:"content",name:"Content",type:"text",elementId:"content",elementName:"Page Content"},{id:"word_count",originalId:"word_count",name:"Word Count",type:"number",elementId:"word_count",elementName:"Word Count"},{id:"author",originalId:"author",name:"Author",type:"text",elementId:"author",elementName:"Author"},{id:"publish_date",originalId:"publish_date",name:"Publish Date",type:"text",elementId:"publish_date",elementName:"Publish Date"}],item:o,originalTextData:{title:a,description:r,content:n,wordCount:s,metadata:i}}}createEmptyResult(t,e=null){const a={url:t,title:"",description:"",content:"",word_count:0,author:"",publish_date:""};return{url:t,success:!e,extractedAt:Date.now(),itemCount:0,columns:[{id:"url",originalId:"url",name:"URL",type:"link",elementId:"url",elementName:"Source URL"},{id:"title",originalId:"title",name:"Title",type:"text",elementId:"title",elementName:"Page Title"},{id:"description",originalId:"description",name:"Description",type:"text",elementId:"description",elementName:"Meta Description"},{id:"content",originalId:"content",name:"Content",type:"text",elementId:"content",elementName:"Page Content"},{id:"word_count",originalId:"word_count",name:"Word Count",type:"number",elementId:"word_count",elementName:"Word Count"},{id:"author",originalId:"author",name:"Author",type:"text",elementId:"author",elementName:"Author"},{id:"publish_date",originalId:"publish_date",name:"Publish Date",type:"text",elementId:"publish_date",elementName:"Publish Date"}],item:a,error:e,originalTextData:{title:"",description:"",content:"",wordCount:0,metadata:{}}}}}class y{static getStrategyMetadata(t){return{EXTRACT_PAGES:{requiresElements:!0,description:"Extract custom elements using selectors"},EXTRACT_PAGES_EMAIL:{requiresElements:!1,description:"Extract email addresses from page content"},EXTRACT_PAGES_PHONE:{requiresElements:!1,description:"Extract phone numbers from page content"},EXTRACT_PAGES_TEXT:{requiresElements:!1,description:"Extract webpage content as AI-ready text"},EXTRACT_PAGES_GOOGLE_MAPS:{requiresElements:!1,description:"Extract Google Maps place information"}}[t]||null}static getSupportedActionTypes(){return["EXTRACT_PAGES","EXTRACT_PAGES_EMAIL","EXTRACT_PAGES_PHONE","EXTRACT_PAGES_TEXT","EXTRACT_PAGES_GOOGLE_MAPS"]}static async validateAction(t){const e=t.type;if(!this.getSupportedActionTypes().includes(e))throw new Error(`Unsupported action type: ${e}`);if(!t.urls||!Array.isArray(t.urls)||0===t.urls.length)throw new Error(`${e} action requires a non-empty urls array`);switch(e){case"EXTRACT_PAGES":await this.validateExtractPagesAction(t);break;case"EXTRACT_PAGES_EMAIL":await this.validateExtractEmailAction(t);break;case"EXTRACT_PAGES_PHONE":await this.validateExtractPhoneAction(t);break;case"EXTRACT_PAGES_TEXT":await this.validateExtractTextAction(t);break;case"EXTRACT_PAGES_GOOGLE_MAPS":await this.validateExtractGoogleMapsAction(t)}}static async validateExtractPagesAction(t){if(!t.elements||!Array.isArray(t.elements)||0===t.elements.length)throw new Error("EXTRACT_PAGES action requires a non-empty elements array");for(const e of t.elements)if(!e.selector&&!e.selectors)throw new Error(`Element "${e.name||"unnamed"}" must have either selector or selectors property`)}static async validateExtractEmailAction(t){if(t.config&&t.config.emailPatterns&&!Array.isArray(t.config.emailPatterns))throw new Error("emailPatterns must be an array if provided")}static async validateExtractPhoneAction(t){if(t.config&&t.config.phonePatterns&&!Array.isArray(t.config.phonePatterns))throw new Error("phonePatterns must be an array if provided")}static async validateExtractTextAction(t){if(t.config&&void 0!==t.config.includeMetadata&&"boolean"!=typeof t.config.includeMetadata)throw new Error("includeMetadata must be a boolean if provided")}static async validateExtractGoogleMapsAction(t){if(t.config&&t.config.extractionOptions&&"object"!=typeof t.config.extractionOptions)throw new Error("extractionOptions must be an object if provided")}static createExtractor(t,e,a,r,n){switch(t){case"EXTRACT_PAGES":return new h(e,a,r,n);case"EXTRACT_PAGES_EMAIL":return new m(e,a,r,n);case"EXTRACT_PAGES_PHONE":return new g(e,a,r,n);case"EXTRACT_PAGES_TEXT":return new f(e,a,r,n);case"EXTRACT_PAGES_GOOGLE_MAPS":return new p(e,a,r,n);default:throw new Error(`Unsupported extraction type: ${t}`)}}}const w={default:new class extends s{constructor(){super()}async execute(t,e,a){this.isRunning=!0,this.cancelled=!1,this.automationId=t;const n=[];try{for(let t=0;t<a.length;t++){const s=a[t];if(this.cancelled)break;const i=await this.executeAction(e,s);n.push(i),r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_PROGRESS,{currentAction:t+1,totalActions:a.length,lastResult:i}),s.delay&&s.delay>0&&await this.delay(s.delay)}return n}catch(t){throw t}finally{this.isRunning=!1}}},listExtractor:new class extends s{constructor(){super()}stop(){this.cancelled=!0,this.isRunning=!1}sendProgressUpdate(t,e={},a=null){const r=a||`Performing ${t} action...`,n={action:t,details:e,message:r};this.reportProgress(0,0,{message:r,lastResult:n})}async execute(t,e,a,r){this.automationId=t,this.tableDataId=r,this.tabId=e,this.isRunning=!0,this.cancelled=!1;try{if(!e)throw new Error(" [LISTEXTRACTOR-RUNNER] No tabId provided");const{listAction:n,loadMoreAction:s}=await this.validateActions(a);if(this.cancelled)return this.createStandardResult(!0,{status:"stopped",cancelled:!0});if(this.listAction=n,!this.automationId||!this.tableDataId)throw new Error(" [LISTEXTRACTOR-RUNNER] No automation ID or tableData ID provided for context",{automationId:t,tableDataId:r});if(c.W.setTableContext(this.tableDataId,{extractionType:"list",selector:n.selector,url:await this.getCurrentUrl(e)}),this.cancelled)return this.createStandardResult(!0,{status:"stopped",cancelled:!0});if(await this.preparePageForExtraction(e,n.containerSelector.value,n.containerSelector.type),this.cancelled)return this.createStandardResult(!0,{status:"stopped",cancelled:!0});let i;try{if(this.cancelled)return this.createStandardResult(!0,{status:"stopped",cancelled:!0});switch(s.method){case"scroll":const t={maxNoChanges:void 0!==s.maxNoChanges?s.maxNoChanges:2,contentLoadDelay:void 0!==s.contentLoadDelay?s.contentLoadDelay:2e3,scrollDelay:void 0!==s.scrollDelay?s.scrollDelay:50,minScrollChange:100,minHeightChange:100,sampleSize:10};i=await this.executeInfiniteScroll(e,n.containerSelectors,t);break;case"navigate":i=await this.executePaginationNext(e,n.containerSelectors,s.paginationSelectors,s);break;case"click_button":i=await this.executePaginationLoadMore(e,n.containerSelectors,s.paginationSelectors,s);break;default:i={success:!1,error:`Unsupported LOAD_MORE method: ${s.method}`}}}catch(t){i={success:!1,error:t.message}}!this.cancelled||i&&i.cancelled||(i={success:!0,method:i?.method||"unknown",cancelled:!0});return await this.processResults(e,i,n)}catch(t){throw t}finally{this.isRunning=!1}}async validateActions(t){const e=t.find((t=>"EXTRACT_LIST"===t.type)),a=t.find((t=>"LOAD_MORE"===t.type));if(!e||!a)throw new Error("Missing required actions: EXTRACT_LIST or LOAD_MORE");if(!e.allSelectors||!Array.isArray(e.allSelectors)||0===e.allSelectors.length)throw new Error("EXTRACT_LIST action has an invalid allSelectors array. It requires at least one selector");const r=await this.findView(this.tabId,e.allSelectors,"list container");if(!r.success)throw new Error(`Failed to find valid list container: ${r.error}`);if(e.containerSelector={type:r.selectorType,value:r.selector},e.containerSelectors=e.allSelectors,"navigate"===a.method||"click_button"===a.method){if(!a.buttonSelectors||!Array.isArray(a.buttonSelectors)||0===a.buttonSelectors.length)throw new Error("LOAD_MORE action with navigate method requires at least one button selector");a.paginationSelectors=a.buttonSelectors}return{listAction:e,loadMoreAction:a}}async processResults(t,e,a){try{await c.W.flush();const t={totalItems:await c.W.getRowCount()||0,cancelled:this.cancelled||!1,method:e?.method||"unknown"};return!1!==e?.success?this.createStandardResult(!0,{summary:t,status:this.cancelled?"stopped":"completed"}):this.createStandardResult(!1,{error:e?.error||"Unknown error in load more operation",summary:t,status:"failed"})}catch(t){return this.createStandardResult(!1,{error:t.message,summary:{totalItems:0,cancelled:this.cancelled||!1}})}}async executeInfiniteScroll(t,e,a={}){try{const r={maxNoChanges:2,contentLoadDelay:2e3,scrollDelay:50,minScrollChange:100,minHeightChange:100,sampleSize:10,...a};this.sendProgressUpdate("initialize",{method:"infinite_scroll"},"Initializing infinite scroll extraction...");let n={consecutiveNoChanges:0,previousContentHash:"",lastScrollPosition:0,lastChildHashData:null,totalItemsFound:0};for(;n.consecutiveNoChanges<r.maxNoChanges&&!this.cancelled;){const a=await this.findView(t,e,"infinite scroll container");if(!a.success)throw new Error(` [LISTEXTRACTOR-RUNNER] No valid container found for infinite scroll: ${a.error}`);const s=a.selectorType,i=a.selector,o=await this.calculateContentHash(t,i,r.sampleSize,s),l=await this.getExtractedItemsCount();this.sendProgressUpdate("scroll",{scrollPosition:n.lastScrollPosition,attempt:n.consecutiveNoChanges+1,maxAttempts:r.maxNoChanges},"Scrolling to load more content...");const u=await this.executeScrollByRows(t,{parentSelector:i,selectorType:s,scrollDelay:r.scrollDelay,startIndex:n.lastScrollPosition,childHash:n.lastChildHashData?JSON.stringify(n.lastChildHashData):null,scrollCallback:async e=>{if(this.cancelled)return;this.sendProgressUpdate("extract",{currentIndex:e.currentIndex,totalItems:l},"Extracting data from list items...");const a=await this.extractListItemData(t,i,s,null,e.currentIndex);this.syncExtractedListItem(a)}});if(await c.W.flush(),this.cancelled)break;if(this.updateStateFromScrollResult(n,u),this.sendProgressUpdate("wait",{waitTime:r.contentLoadDelay,reason:"content load"},`Waiting for content to load (${Math.round(r.contentLoadDelay/1e3)}s)...`),await this.delay(r.contentLoadDelay),this.cancelled)break;const d=await this.calculateContentHash(t,i,r.sampleSize,s),h=await this.getExtractedItemsCount(),m=h-l;n.totalItemsFound+=m,this.sendProgressUpdate("progress",{newItemsFound:m,totalItems:h},`Extracted ${m} new items (total: ${h})`);const g=this.detectContentChanges(o,d,r,n.previousContentHash);if(g.anyChange||g.scrollPositionChanged)this.logDetectedChanges(g,o,d),n.consecutiveNoChanges=0,n.previousContentHash=d.hash;else if(n.consecutiveNoChanges++,n.consecutiveNoChanges>=r.maxNoChanges||u.result?.reachedBottom){this.sendProgressUpdate("complete",{reason:u.result?.reachedBottom?"reached bottom":"no more changes",totalItems:h},"Infinite scroll complete - no more content available");break}}return{success:!0,method:"infinite_scroll",cancelled:this.cancelled}}catch(t){return this.sendProgressUpdate("error",{error:t.message},`Error in infinite scrolling: ${t.message}`),{success:!1,error:t.message,method:"infinite_scroll"}}}async executePaginationNext(t,e,a,r={}){try{const n={navigationDelay:1500,contentLoadDelay:2e3,scrollDelay:150,pageLoadDelay:1e3,urlChangeTimeout:5e3,urlChangePollInterval:100,maxAttempts:-1,maxContentNoChange:1,...r};this.sendProgressUpdate("initialize",{method:"navigate"},"Initializing pagination extraction...");const s=-1===n.maxAttempts;let i={pagesProcessed:0,consecutiveNoContentChanges:0,lastChildHashData:null,totalItemsFound:0};for(;(s||i.pagesProcessed<n.maxAttempts)&&!this.cancelled;){const r=await this.findView(t,e,"list container");if(!r.success)throw new Error(` [LISTEXTRACTOR-RUNNER] No valid container found for extract + pagination: ${r.error}`);const o=r.selector,l=r.selectorType;i.pagesProcessed++,this.sendProgressUpdate("navigate",{page:i.pagesProcessed,maxAttempts:-1===n.maxAttempts?"unlimited":n.maxAttempts},`Processing page ${i.pagesProcessed}`);const u=await this.getExtractedItemsCount();if(this.cancelled)break;this.sendProgressUpdate("extract",{page:i.pagesProcessed,totalItems:u},"Extracting data from current page...");const d=await this.executeScrollByRows(t,{parentSelector:o,selectorType:l,scrollDelay:n.scrollDelay,childHash:null,scrollCallback:async e=>{if(this.cancelled)return;const a=await this.extractListItemData(t,o,l,null,e.currentIndex);this.syncExtractedListItem(a)}});await c.W.flush(),this.updateStateFromScrollResult(i,d);const h=await this.getExtractedItemsCount(),m=h-u;if(this.sendProgressUpdate("progress",{page:i.pagesProcessed,newItemsFound:m,totalItems:h},`Extracted ${m} items from page ${i.pagesProcessed} (total: ${h})`),m<=0){if(i.consecutiveNoContentChanges++,i.consecutiveNoContentChanges>=n.maxContentNoChange){this.sendProgressUpdate("complete",{reason:"no more new content",totalItems:h,pagesProcessed:i.pagesProcessed},"Pagination complete - no more new content found");break}}else i.consecutiveNoContentChanges=0,i.totalItemsFound+=m;if(this.cancelled)break;if(!s&&i.pagesProcessed>=n.maxAttempts){this.sendProgressUpdate("complete",{reason:"max attempts reached",totalItems:h,pagesProcessed:i.pagesProcessed},`Pagination complete - reached maximum of ${n.maxAttempts} pages`);break}const g=await this.calculateContentHash(t,o,10,l),p=await this.getCurrentUrl(t),f=await this.findClickableElement(t,a,"pagination button",{requireVisible:!0,requireEnabled:!0,requireInViewport:!1});if(!f.success){this.sendProgressUpdate("complete",{reason:"no more pagination buttons",totalItems:h,pagesProcessed:i.pagesProcessed},"Pagination complete - no more 'Next' buttons found");break}const y=f.selector,w=f.selectorType;this.sendProgressUpdate("click",{page:i.pagesProcessed,nextPage:i.pagesProcessed+1,buttonSelector:y,buttonSelectorType:w},"Clicking 'Next Page' button...");const b=await this.clickElementSimple(t,y,w,{maxRetries:3,retryDelay:2e3,clickHoldTime:{min:120,max:180},highlight:{enabled:!0,outlineColor:"rgba(0, 255, 0, 0.8)",backgroundColor:"rgba(0, 255, 0, 0.1)",duration:1500}});if(!b.success){this.sendProgressUpdate("complete",{reason:"unable to click next button",totalItems:h,pagesProcessed:i.pagesProcessed,error:b.error},"Pagination complete - unable to click 'Next' button");break}this.sendProgressUpdate("wait",{waitTime:n.navigationDelay,reason:"navigation"},`Waiting for navigation (${Math.round(n.navigationDelay/1e3)}s)...`),await this.delay(n.navigationDelay);if(await this.waitUntilUrlChanges(t,p,n.urlChangeTimeout,n.urlChangePollInterval))this.sendProgressUpdate("wait",{waitTime:n.contentLoadDelay,reason:"content load after navigation"},`Waiting for new page content to load (${Math.round(n.contentLoadDelay/1e3)}s)...`),await this.delay(n.contentLoadDelay),this.sendProgressUpdate("progress",{status:"url changed and content loaded",nextPage:i.pagesProcessed+1},"URL changed after pagination, content loaded, continuing to next page");else{this.sendProgressUpdate("wait",{waitTime:n.contentLoadDelay,reason:"content load"},`Waiting for content to load (${Math.round(n.contentLoadDelay/1e3)}s)...`),await this.delay(n.contentLoadDelay);const e=await this.calculateContentHash(t,o,10,l);if(!(g.hash!==e.hash)){this.sendProgressUpdate("complete",{reason:"no content changes after navigation",totalItems:h,pagesProcessed:i.pagesProcessed},"Pagination complete - no content changes after navigation");break}this.sendProgressUpdate("progress",{status:"content changed",nextPage:i.pagesProcessed+1},"Content changed after pagination, continuing to next page")}this.sendProgressUpdate("wait",{waitTime:n.pageLoadDelay,reason:"page load"},`Waiting for page to load (${Math.round(n.pageLoadDelay/1e3)}s)...`),await this.delay(n.pageLoadDelay)}return{success:!0,method:"navigate",pagesProcessed:i.pagesProcessed,cancelled:this.cancelled}}catch(t){return this.sendProgressUpdate("error",{error:t.message},`Error in pagination: ${t.message}`),{success:!1,error:t.message,method:"navigate"}}}async executePaginationLoadMore(t,e,a,r={}){try{const n={contentLoadDelay:2e3,maxAttempts:-1,scrollDelay:150,maxRetryAttempts:2,...r};this.sendProgressUpdate("initialize",{method:"click_button"},"Initializing 'Load More' button extraction...");const s=-1===n.maxAttempts;let i={pagesProcessed:0,retryAttempts:0,lastChildHashData:null};for(;(s||i.pagesProcessed<n.maxAttempts)&&!this.cancelled;){const r=await this.findView(t,e,"list container");if(!r.success)throw new Error(` [LISTEXTRACTOR-RUNNER] No valid container found for extract + pagination: ${r.error}`);const s=r.selector,o=r.selectorType,l=await this.getExtractedItemsCount();if(this.cancelled)break;this.sendProgressUpdate("extract",{loadMoreCount:i.pagesProcessed,totalItems:l},"Extracting data from list items...");const u=await this.executeScrollByRows(t,{parentSelector:s,selectorType:o,scrollDelay:n.scrollDelay,childHash:i.lastChildHashData?JSON.stringify(i.lastChildHashData):null,scrollCallback:async e=>{if(this.cancelled)return;const a=await this.extractListItemData(t,s,o,null,e.currentIndex);this.syncExtractedListItem(a)}});if(await c.W.flush(),this.cancelled)break;this.updateStateFromScrollResult(i,u);const d=await this.getExtractedItemsCount(),h=d-l;if(this.sendProgressUpdate("progress",{loadMoreCount:i.pagesProcessed,newItemsFound:h,totalItems:d},`Extracted ${h} new items (total: ${d})`),0===h){if(i.retryAttempts++,i.retryAttempts>=n.maxRetryAttempts){this.sendProgressUpdate("complete",{reason:"no new items after retries",totalItems:d,retryAttempts:i.retryAttempts},`Load More complete - no new items after ${i.retryAttempts} attempts`);break}}else i.retryAttempts=0;if(this.cancelled)break;const m=await this.findClickableElement(t,a,"load more button",{requireVisible:!0,requireEnabled:!0,requireInViewport:!1});if(!m.success){this.sendProgressUpdate("complete",{reason:"no load more button found",totalItems:d,loadMoreCount:i.pagesProcessed},"Load More complete - no more 'Load More' buttons found");break}const g=m.selector,p=m.selectorType;this.sendProgressUpdate("click",{buttonSelector:g,buttonSelectorType:p},"Clicking 'Load More' button...");const f=await this.clickElementSimple(t,g,p,{maxRetries:3,retryDelay:1500,clickHoldTime:{min:100,max:160},highlight:{enabled:!0,outlineColor:"rgba(0, 150, 255, 0.8)",backgroundColor:"rgba(0, 150, 255, 0.1)",duration:1500}});if(f.success)this.sendProgressUpdate("wait",{waitTime:n.contentLoadDelay,reason:"content load"},`Waiting for content to load (${Math.round(n.contentLoadDelay/1e3)}s)...`),await this.delay(n.contentLoadDelay),i.pagesProcessed++;else if(i.retryAttempts++,this.sendProgressUpdate("retry",{reason:"button click failed",retryAttempt:i.retryAttempts,maxRetryAttempts:n.maxRetryAttempts,error:f.error},`Button click failed, retry attempt ${i.retryAttempts}/${n.maxRetryAttempts}`),i.retryAttempts>=n.maxRetryAttempts){this.sendProgressUpdate("complete",{reason:"button click failed after retries",totalItems:d,retryAttempts:i.retryAttempts,error:f.error},`Load More complete - button click failed after ${i.retryAttempts} attempts`);break}}return{success:!0,method:"click_button",pagesProcessed:i.pagesProcessed,cancelled:this.cancelled}}catch(t){return this.sendProgressUpdate("error",{error:t.message},`Error in Load More extraction: ${t.message}`),{success:!1,error:t.message,method:"click_button"}}}updateStateFromScrollResult(t,e){e&&e.success&&e.result&&(void 0!==e.result.currentIndex&&(t.lastScrollPosition=e.result.currentIndex),e.result.lastChildHashData&&(t.lastChildHashData=e.result.lastChildHashData))}logDetectedChanges(t,e,a){t.countChanged,t.contentChanged,t.scrollHeightChanged}async extractListItemData(t,e,a,r,n){if(!e||!a)return{success:!1,error:"Missing selector or selector type in parameters"};if(!r&&"number"!=typeof n)return{success:!1,error:"Must provide either itemHashData or itemIndex"};try{let s=r;"object"==typeof r&&null!==r&&(s=JSON.stringify(r));const o=(await chrome.scripting.executeScript({target:{tabId:t},func:i,args:[e,s,n,a]}))[0].result;return o.success?{success:!0,list:{selector:e,selectorType:a,itemHashData:r,itemIndex:n,item:o.item,columns:o.columns||[]}}:{success:!1,error:o.error||"Unknown extraction error"}}catch(t){return{success:!1,error:t.message}}}async syncExtractedListItem(t){try{const e=t?.list?.item;if(!e||!1===e?.success)throw new Error(" [LISTEXTRACTOR-RUNNER] "+(e?"Item extraction failed":"No item found in extraction result"));const a=t.list.columns;if(!a||0===a.length)return;await c.W.addRow(e,{}),await c.W.updateTableColumns(a)}catch(t){}}async getExtractedItemsCount(){if(!this.tableDataId)return 0;try{return await c.W.getRowCount()}catch(t){return 0}}detectContentChanges(t,e,a,r){const n=e.count>t.count,s=e.hash!==t.hash&&e.hash!==r,i=Math.abs(e.scrollTop-t.scrollTop)>a.minScrollChange,o=e.scrollHeight>t.scrollHeight+a.minHeightChange;return{countChanged:n,contentChanged:s,scrollPositionChanged:i,scrollHeightChanged:o,anyChange:n||s||o}}async calculateContentHash(t,e,a=30,r="selector"){return(await chrome.scripting.executeScript({target:{tabId:t},func:(t,e,a)=>{let r;if("selector"===a.toLowerCase())r=document.querySelector(t);else if("xpath"===a.toLowerCase()){r=document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}if(!r)return{count:0,hash:"0"};const n=Array.from(r.children),s=n.length;let i="";const o=[],c=Math.min(e,s);for(let t=0;t<c;t++)o.push(t);if(s>e){for(let t=Math.max(c,s-e);t<s;t++)o.push(t)}if(s>2*e){const t=Math.floor(s/2),a=Math.max(c,t-Math.floor(e/2)),r=Math.min(s-e,t+Math.floor(e/2));for(let t=a;t<r;t++)o.push(t)}const l=[...new Set(o)];l.forEach((t=>{const e=n[t];if(!e)return;i+=`[${t}]`+e.textContent.trim().substring(0,100);const a=e.getBoundingClientRect();i+=`|pos:${a.top.toFixed(0)},${a.left.toFixed(0)}|`,i+=`|size:${a.width.toFixed(0)}x${a.height.toFixed(0)}|`,i+=`|vis:${"none"!==window.getComputedStyle(e).display}|`;const r=e.querySelectorAll("img");r.length>0&&(i+=Array.from(r).slice(0,3).map((t=>t.src||t.getAttribute("data-src")||"")).join("|"));const s=e.querySelectorAll("a");s.length>0&&(i+=Array.from(s).slice(0,3).map((t=>t.href||"")).join("|")),i+="||"})),i+=`|container:${r.scrollTop},${r.scrollHeight},${r.offsetHeight}|`;let u=0;for(let t=0;t<i.length;t++)u=(u<<5)-u+i.charCodeAt(t),u|=0;return{count:s,hash:u.toString(),scrollTop:r.scrollTop||window.scrollY,scrollHeight:r.scrollHeight||document.documentElement.scrollHeight,sampleSize:l.length,containerHeight:r.offsetHeight}},args:[e,a,r]}))[0].result}async preparePageForExtraction(t,e,a="selector"){await this.performScroll(t,{type:"SCROLL",direction:"to-top",smooth:!1});const r=await this.scrollElementIntoView(t,{selector:e,selectorType:a,block:"start",inline:"start",smooth:!1});r?.success&&await chrome.scripting.executeScript({target:{tabId:t},func:function(t){window.scrollBy({top:-t,behavior:"auto"})},args:[50]}),await this.delay(500),await this.highlightTargetElements(t,e,a)}async highlightTargetElements(t,e,a="selector"){await this.highlightChildren(t,{selector:e,selectorType:a,duration:2e3}),await this.delay(2e3)}async findView(t,e,a="container"){try{if(!e||!Array.isArray(e)||0===e.length)return{success:!1,error:`No ${a} selectors provided`};const r=await this.findViewBySelectors(t,e);return r.success?{success:!0,selector:r.value,selectorType:r.type,index:r.index}:{success:!1,error:r.error||`No valid ${a} selector found`}}catch(t){return{success:!1,error:`Error finding ${a}: ${t.message}`}}}},metadataExtractor:new class extends s{constructor(){super()}async execute(t,e,a){this.isRunning=!0,this.cancelled=!1,this.automationId=t;try{let t;await this.preparePageForExtraction(e),this.reportProgress(1,3,{message:"Starting metadata extraction..."}),t=Array.isArray(a)?a[0]:a.config?a.config:a,this.reportProgress(2,3,{message:"Extracting metadata..."});const r=await this.extractMetadata(e,t);return r.success?(this.reportProgress(3,3,{message:"Metadata extraction complete"}),{success:!0,metadata:r.metadata,summary:{url:r.metadata.url,title:r.metadata.title,totalMetaTags:r.stats.metaCount,totalOpenGraphTags:r.stats.ogCount,totalTwitterTags:r.stats.twitterCount,hasSchema:r.stats.hasSchema,hasJsonLd:r.stats.hasJsonLd,hasFavicon:r.stats.hasFavicon}}):{success:!1,error:r.error}}catch(t){return{success:!1,error:t.message||"Unknown error during metadata extraction"}}finally{this.isRunning=!1}}async preparePageForExtraction(t){try{await chrome.scripting.executeScript({target:{tabId:t},func:()=>window.scrollTo(0,0)}),await this.delay(300)}catch(t){}}async extractMetadata(t,e){try{const a=await chrome.scripting.executeScript({target:{tabId:t},func:function(t){const{metaTags:e,metaCount:a}=(()=>{if(!t.extractTypes.meta)return{};const e={},a=document.querySelectorAll("meta");let r=0;if(a.forEach((t=>{const a=t.getAttribute("name");if(a)return e[a]=t.getAttribute("content"),void r++;const n=t.getAttribute("property");if(n&&!n.startsWith("og:")&&!n.startsWith("twitter:"))return e[n]=t.getAttribute("content"),void r++;const s=t.getAttribute("http-equiv");return s?(e[`http-equiv:${s}`]=t.getAttribute("content"),void r++):void 0})),t.customMetaTags){t.customMetaTags.split("\n").map((t=>t.trim())).filter((t=>t)).forEach((t=>{const a=document.querySelector(`meta[name="${t}"]`);a&&(e[t]=a.getAttribute("content"))}))}return{metaTags:e,metaCount:r}})(),{ogTags:r,ogCount:n}=(()=>{if(!t.extractTypes.openGraph)return{};const e={},a=document.querySelectorAll('meta[property^="og:"]');let r=0;return a.forEach((t=>{const a=t.getAttribute("property");a&&(e[a.replace("og:","")]=t.getAttribute("content"),r++)})),{ogTags:e,ogCount:r}})(),{twitterTags:s,twitterCount:i}=(()=>{if(!t.extractTypes.twitter)return{};const e={},a=document.querySelectorAll('meta[name^="twitter:"]');let r=0;return a.forEach((t=>{const a=t.getAttribute("name");a&&(e[a.replace("twitter:","")]=t.getAttribute("content"),r++)})),{twitterTags:e,twitterCount:r}})(),{schemaData:o,hasSchema:c}=(()=>{if(!t.extractTypes.schema)return{};let e={},a=!1;const r=document.querySelectorAll("[itemscope]");return r.length>0&&(a=!0,e=Array.from(r).map((t=>{const e=t.getAttribute("itemtype"),a={};return t.querySelectorAll("[itemprop]").forEach((t=>{const e=t.getAttribute("itemprop");a[e]=t.textContent.trim()})),{type:e,properties:a}}))),{schemaData:e,hasSchema:a}})(),{jsonLdData:l,hasJsonLd:u}=(()=>{if(!t.extractTypes.jsonLd)return{};let e=[],a=!1;const r=document.querySelectorAll('script[type="application/ld+json"]');return r.length>0&&(a=!0,e=Array.from(r).map((t=>{try{return JSON.parse(t.textContent)}catch(t){return{error:"Invalid JSON-LD"}}}))),{jsonLdData:e,hasJsonLd:a}})(),{favicon:d,hasFavicon:h}=(()=>{if(!t.extractTypes.favicon)return{};let e=null,a=!1;const r=document.querySelector('link[rel="icon"], link[rel="shortcut icon"]');return r?(e=r.href,a=!0):e=new URL("/favicon.ico",window.location.origin).href,{favicon:e,hasFavicon:a}})(),m=t.validateData?function(t,e,a){const r={metaTags:{...t},ogTags:{...e},twitterTags:{...a},issues:[]};t.title||e.title||r.issues.push("Missing page title in meta tags");t.description||e.description||r.issues.push("Missing page description in meta tags");t.canonical||null!==document.querySelector('link[rel="canonical"]')||r.issues.push("Missing canonical URL");t.viewport||r.issues.push("Missing viewport meta tag");Object.keys(e).length>0&&(e.title||r.issues.push("Missing og:title"),e.description||r.issues.push("Missing og:description"),e.image||r.issues.push("Missing og:image"),e.url||r.issues.push("Missing og:url"));Object.keys(a).length>0&&(a.card||r.issues.push("Missing twitter:card"),a.title||r.issues.push("Missing twitter:title"),a.description||r.issues.push("Missing twitter:description"));return r}(e,r,s):{metaTags:e,ogTags:r,twitterTags:s};return{success:!0,metadata:{url:window.location.href,title:document.title,metaTags:m.metaTags||{},openGraph:r||{},twitter:s||{},schema:o||{},jsonLd:l||[],favicon:d||"",issues:m.issues||[]},stats:{metaCount:a,ogCount:n,twitterCount:i,hasSchema:c,hasJsonLd:u,hasFavicon:h}}},args:[e]});return a[0].result}catch(t){return{success:!1,error:t.message||"Error executing metadata extraction"}}}},pageExtractor:new class extends s{constructor(){super(),this.runnerType="pageExtractor",this.activeTabs=new Map,this.extractionQueue=[],this.results=new Map,this.config=null,this.maxTabsLimit=10,this.currentAction=null,this.initialTabId=null,this.subPageResults=[],this.totalPagesScanned=0}stop(){this.cancelled=!0,this.isRunning=!1,this.cleanupActiveTabs().catch((t=>{}))}async gracefulShutdown(){this.cancelled=!0,this.isRunning=!1,await this.cleanupActiveTabs(),this.extractionQueue=[],this.results.clear(),this.initialTabId=null}sendProgressUpdate(t,e={},a=null){const r=a||`Performing ${t} action...`,n={action:t,details:e,message:r};this.reportProgress(0,0,{message:r,lastResult:n})}updateUrlStatus(t,e,a={}){this.urlStatuses||(this.urlStatuses=new Map);let r=null;if("failed"===e&&a.error){const t=a.error.toLowerCase();r=t.includes("network")||t.includes("internet")||t.includes("connection")||t.includes("dns")?"network_error":t.includes("timeout")?"timeout_error":t.includes("http")||t.includes("404")||t.includes("403")||t.includes("500")?"http_error":t.includes("ssl")||t.includes("certificate")||t.includes("security")?"ssl_error":t.includes("invalid url")||t.includes("url format")?"invalid_url_error":t.includes("blocked")?"blocked_error":"unknown_error"}this.urlStatuses.set(t,{status:e,timestamp:Date.now(),errorCategory:r,...a});const n=Array.from(this.urlStatuses.values()),s=n.filter((t=>"success"===t.status||"failed"===t.status)).length,i=n.filter((t=>"success"===t.status)).length,o=n.filter((t=>"failed"===t.status)).length,c=n.filter((t=>"success"===t.status)).reduce(((t,e)=>t+(e.itemCount||0)),0),l=this.urlStatuses.size,u={};n.filter((t=>"failed"===t.status&&t.errorCategory)).forEach((t=>{u[t.errorCategory]=(u[t.errorCategory]||0)+1})),this.sendProgressUpdate("url_status_update",{processedUrls:s,totalUrls:l,successfulUrls:i,failedUrls:o,extractedItems:c,errorBreakdown:u,urlProgress:Object.fromEntries(this.urlStatuses),currentUrl:t,currentUrlStatus:e,currentUrlErrorCategory:r,subPageResults:this.subPageResults||[],totalPagesScanned:this.totalPagesScanned||0},`${"processing"===e?"Processing":"success"===e?"Completed":"failed"===e?"Failed":"Queued"}: ${t}`)}async execute(t,e,a,r){this.automationId=t,this.tableDataId=r,this.tabId=e,this.isRunning=!0,this.cancelled=!1;try{if(!r)throw new Error(" [PAGE-EXTRACTOR-RUNNER] No tableDataId provided");const t=await this.validateActions(a);if(this.currentAction=t,this.cancelled)return this.createStandardResult(!0,{status:"stopped",cancelled:!0});if(this.config={maxConcurrentTabs:3,delayBetweenRequests:1e3,timeoutPerPage:3e4,pageLoadTimeout:1e4,elementWaitTimeout:5e3,waitForPageLoad:!0,waitForElements:!0,enableRandomization:!1,randomizeDelays:!0,delayRandomizationRange:50,minRandomDelay:500,maxRandomDelay:3e3,...t.config},this.config.maxConcurrentTabs=Math.min(this.config.maxConcurrentTabs,this.maxTabsLimit),this.automationId&&this.tableDataId){const e=y.getStrategyMetadata(t.type);c.W.setTableContext(this.tableDataId,{extractionType:t.type.toLowerCase(),actionType:t.type,urlsCount:t.urls.length,description:e.description})}if(this.cancelled)return this.createStandardResult(!0,{status:"stopped",cancelled:!0});this.initializeExtraction(t.urls,t.elements);const e=y.getStrategyMetadata(t.type);this.sendProgressUpdate("initialize",{actionType:t.type,totalUrls:t.urls.length,totalElements:e.requiresElements&&t.elements?.length||0,maxConcurrentTabs:this.config.maxConcurrentTabs,description:e.description},`Initializing ${e.description.toLowerCase()} for ${t.urls.length} URLs with ${this.config.maxConcurrentTabs} concurrent tabs...`);const n=await this.executeBulkExtraction(t.urls,t.elements);!this.cancelled||n&&n.cancelled||(n.cancelled=!0);return await this.processResults(n)}catch(t){return this.createStandardResult(!1,{error:t.message,status:"failed"})}finally{this.isRunning=!1,await this.gracefulShutdown()}}async validateActions(t){const e=y.getSupportedActionTypes(),a=t.find((t=>e.includes(t.type)));if(!a)throw new Error(`Missing required action. Supported types: ${e.join(", ")}`);return await y.validateAction(a),a}initializeExtraction(t,e){this.activeTabs.clear(),this.results.clear(),this.extractionQueue=[...t],this.urlStatuses=new Map,this.subPageResults=[],this.totalPagesScanned=0,t.forEach((t=>{this.updateUrlStatus(t,"queued")}))}async executeBulkExtraction(t,e){const a={success:!0,method:"bulk_extraction",cancelled:!1,processedUrls:0,failedUrls:0,extractedItems:0,errors:[]},r=[...t],n=new Map;let s=0;try{for(;r.length>0||n.size>0;){if(this.cancelled){a.cancelled=!0;break}for(;r.length>0&&n.size<this.config.maxConcurrentTabs;){const t=r.shift();this.updateUrlStatus(t,"processing");const a=this.processUrlWithRetry(t,e);n.set(t,a)}if(n.size>0){const e=await this.waitForAnyExtraction(n);if(e){const r=await n.get(e);n.delete(e),s++,r.success?(a.processedUrls++,a.extractedItems+=r.itemCount||0,this.updateUrlStatus(e,"success",{itemCount:r.itemCount})):(a.failedUrls++,a.errors.push({url:e,error:r.error}),this.updateUrlStatus(e,"failed",{error:r.error})),this.sendProgressUpdate("extract",{processedUrls:s,totalUrls:t.length,successfulUrls:a.processedUrls,failedUrls:a.failedUrls,extractedItems:a.extractedItems,activeExtractions:n.size,urlProgress:this.urlStatuses?Object.fromEntries(this.urlStatuses):{}},`Processed ${s}/${t.length} URLs (${a.processedUrls} successful, ${a.failedUrls} failed)`),this.config.delayBetweenRequests>0&&!this.cancelled&&await this.randomizedDelay(this.config.delayBetweenRequests)}}}for(;n.size>0&&!this.cancelled;){const t=await this.waitForAnyExtraction(n);if(t){const e=await n.get(t);n.delete(t),s++,e.success?(a.processedUrls++,a.extractedItems+=e.itemCount||0,this.updateUrlStatus(t,"success",{itemCount:e.itemCount})):(a.failedUrls++,a.errors.push({url:t,error:e.error}),this.updateUrlStatus(t,"failed",{error:e.error}))}}}catch(t){a.success=!1,a.error=t.message}return this.sendProgressUpdate("complete",{processedUrls:a.processedUrls,totalUrls:t.length,successfulUrls:a.processedUrls,failedUrls:a.failedUrls,extractedItems:a.extractedItems,cancelled:a.cancelled,urlProgress:this.urlStatuses?Object.fromEntries(this.urlStatuses):{}},a.cancelled?`Extraction stopped: ${a.processedUrls}/${t.length} URLs processed`:`Extraction completed: ${a.processedUrls}/${t.length} URLs processed successfully`),a}async processResults(t){try{await c.W.flush();const e=await c.W.getRowCount()||0,a={totalUrls:this.extractionQueue.length,successfulUrls:t.processedUrls||0,failedUrls:t.failedUrls||0,totalItems:e,cancelled:this.cancelled||!1};return!1!==t?.success?this.createStandardResult(!0,{summary:a,status:this.cancelled?"stopped":"completed"}):this.createStandardResult(!1,{error:t?.error||"Unknown error in bulk extraction",summary:a,status:"failed"})}catch(t){return this.createStandardResult(!1,{error:t.message,summary:{totalUrls:this.extractionQueue.length,successfulUrls:0,failedUrls:0,totalItems:0,cancelled:this.cancelled||!1},status:"failed"})}}async processUrlWithRetry(t,e){let a=null,r=!0;for(let n=1;n<=2&&r;n++){if(this.cancelled)return{success:!1,error:"Extraction cancelled",cancelled:!0};try{const s=await this.processSingleUrl(t,e);if(s.success)return s;if(a=s.error,r=this.shouldRetryError(s.error),r&&n<2)await this.randomizedDelay(1e3*n);else if(!r)break}catch(t){if(a=t.message,r=this.shouldRetryError(t.message),r&&n<2)await this.randomizedDelay(1e3*n);else if(!r)break}}return{success:!1,error:a||"Failed after all retry attempts",itemCount:0}}shouldRetryError(t){if(!t)return!0;const e=t.toLowerCase(),a=["invalid url","url format","404","403 forbidden","access denied","blocked","certificate error","ssl error","dns_probe_finished_nxdomain","err_name_not_resolved"];for(const t of a)if(e.includes(t))return!1;const r=["timeout","connection","network","500","502","503","504","server error","gateway timeout","service unavailable"];for(const t of r)if(e.includes(t))return!0;return!0}async processSingleUrl(t,e){let a=null;try{a=await this.createExtractionTab(t);const r=await this.waitForPageLoad(a,this.config.pageLoadTimeout);if(!r.success){const e=this.handlePageLoadError(r,t);throw new Error(e)}const n=y.createExtractor(this.currentAction?.type||"EXTRACT_PAGES",this,a,this.config,this.tableDataId),s=await n.extractElements(e,t);if(s.success&&this.tableDataId&&await this.storeExtractionResult(t,s),this.config.enableRandomization){const t=1e3*Math.random()+500;await this.delay(t)}return s}catch(e){return{success:!1,url:t,error:e.message,extractedAt:Date.now(),itemCount:0,columns:[],item:{},elementResults:[]}}finally{a&&await this.closeExtractionTab(a)}}async storeExtractionResult(t,e){try{switch(this.currentAction?.type||"EXTRACT_PAGES"){case"EXTRACT_PAGES":e.item&&e.columns?.length&&(await c.W.updateTableColumns(e.columns),await c.W.addRow(e.item,{}));break;case"EXTRACT_PAGES_EMAIL":if(e.item&&e.columns?.length)await c.W.updateTableColumns(e.columns),await c.W.addRow(e.item,{}),e.originalEmailData;else if(e.emails&&e.emails.length>0)for(const a of e.emails){const r=a.split("@")[1]||"";await c.W.addRow(this.tableDataId,{url:t,email:a,domain:r,extractedAt:(new Date).toISOString(),type:"email",sourceUrl:e.sourceUrl||t})}break;case"EXTRACT_PAGES_PHONE":if(e.item&&e.columns?.length)await c.W.updateTableColumns(e.columns),await c.W.addRow(e.item,{}),e.originalPhoneData;else if(e.phones&&e.phones.length>0)for(const a of e.phones)await c.W.addRow(this.tableDataId,{url:t,phone:a,extractedAt:(new Date).toISOString(),type:"phone"});break;case"EXTRACT_PAGES_TEXT":e.item&&e.columns?.length&&(await c.W.updateTableColumns(e.columns),await c.W.addRow(e.item,{}),e.originalTextData);break;case"EXTRACT_PAGES_GOOGLE_MAPS":e.item&&e.columns?.length&&(await c.W.updateTableColumns(e.columns),await c.W.addRow(e.item,{}),e.originalPlaceData)}}catch(t){}c.W.flush().catch((t=>{}))}async waitForAnyExtraction(t){if(0===t.size)return null;const e=Array.from(t.entries()).map((([t,e])=>e.then((e=>({url:t,result:e}))).catch((e=>({url:t,error:e})))));try{return(await Promise.race(e)).url}catch(t){return null}}async cleanupActiveTabs(){const t=[];for(const[e,a]of this.activeTabs)a.createdByRunner&&t.push(this.closeExtractionTab(e));await Promise.allSettled(t),this.activeTabs.clear(),this.initialTabId=null}async createExtractionTab(t){try{new URL(t)}catch(e){throw new Error(`Invalid URL format: ${t}`)}if(1===this.config?.maxConcurrentTabs){if(null!==this.initialTabId)try{await chrome.tabs.get(this.initialTabId);return await chrome.tabs.update(this.initialTabId,{url:t}),await this.applyAntiDetectionMeasures(this.initialTabId),this.activeTabs.set(this.initialTabId,{url:t,createdByRunner:!1,createdAt:Date.now(),status:"loading"}),this.initialTabId}catch(t){this.initialTabId=null}if(null===this.initialTabId)try{const e=await chrome.tabs.query({active:!0,currentWindow:!0});if(e.length>0){const a=e[0];return this.initialTabId=a.id,await chrome.tabs.update(this.initialTabId,{url:t}),await this.applyAntiDetectionMeasures(this.initialTabId),this.activeTabs.set(this.initialTabId,{url:t,createdByRunner:!1,createdAt:Date.now(),status:"loading"}),this.initialTabId}}catch(t){}}if(!await this.canCreateMoreTabs())throw new Error("Cannot create more tabs: system limits reached");try{const e=await chrome.tabs.create({url:t,active:!1});return 1===this.config?.maxConcurrentTabs&&null===this.initialTabId&&(this.initialTabId=e.id),this.activeTabs.set(e.id,{url:t,createdByRunner:!0,createdAt:Date.now(),status:"loading"}),await this.applyAntiDetectionMeasures(e.id),e.id}catch(e){throw e.message.includes("Invalid URL")?new Error(`Invalid URL: ${t}`):e.message.includes("blocked")?new Error(`URL blocked by browser: ${t}`):new Error(`Failed to create tab: ${e.message}`)}}async closeExtractionTab(t){try{const e=this.activeTabs.get(t);e&&e.createdByRunner&&await chrome.tabs.remove(t),this.activeTabs.delete(t)}catch(e){this.activeTabs.delete(t)}}async waitForPageLoad(t,e=1e4){const a=Date.now();return new Promise((r=>{const n=async()=>{try{if(this.cancelled)return void r({success:!1,error:"Operation cancelled",cancelled:!0});if(Date.now()-a>e)return void r({success:!1,error:"Page load timeout",timeout:!0});if("complete"===(await chrome.tabs.get(t)).status){const e=this.activeTabs.get(t);return e&&(e.status="loaded"),void r({success:!0})}setTimeout(n,500)}catch(t){r({success:!1,error:t.message,errorType:"tab_error"})}};n()}))}handlePageLoadError(t,e){let a="Page failed to load",r="page_load_error";if(t.cancelled)r="cancelled",a="Extraction was cancelled";else if(t.timeout)r="timeout",a=`Page load timeout after ${this.config.pageLoadTimeout}ms`;else if(t.errorType)switch(r=t.errorType,t.errorType){case"networkError":a=`Network error: Unable to reach ${e}. Check internet connection.`;break;case"httpError":a=`HTTP error: ${t.error}`;break;case"sslError":a=`SSL/Certificate error: ${t.error}`;break;case"chrome_error":a=`Browser error: Unable to load ${e}`;break;case"redirect_error":a=`Redirect error: ${t.error}`;break;case"invalid_url":a=`Invalid URL: ${e}`;break;case"tab_error":a=`Tab error: ${t.error}`;break;default:a=t.error}return a}async canCreateMoreTabs(){try{const t=(await chrome.tabs.query({})).length,e=this.activeTabs.size,a=50,r=this.maxTabsLimit,n=t<a&&e<r;return n}catch(t){return!1}}async findView(t,e,a="element",r={}){try{if(!e||!Array.isArray(e)||0===e.length)return{success:!1,error:`No ${a} selectors provided`};const n=e.map((t=>({type:"css"===t.type?"selector":t.type,value:t.value})));if(r?.waitForElements&&r?.elementWaitTimeout>0){const e=await this.waitForElementToAppear(t,n,r.elementWaitTimeout);if(e.success)return{success:!0,selector:e.value,selectorType:e.type,index:e.index,waitTime:e.waitTime};if(!e.timedOut)return{success:!1,error:e.error||`Error waiting for ${a}`}}const s=await this.findViewBySelectors(t,n);return s.success?{success:!0,selector:s.value,selectorType:s.type,index:s.index}:{success:!1,error:s.error||`No valid ${a} selector found`}}catch(t){return{success:!1,error:`Error finding ${a}: ${t.message}`}}}async waitForElementToAppear(t,e,a=5e3){const r=Date.now();return new Promise((n=>{const s=async()=>{try{if(this.cancelled)return void n({success:!1,error:"Operation cancelled"});const i=Date.now()-r;if(i>=a)return void n({success:!1,timedOut:!0,error:`Timeout after ${a}ms waiting for element to appear`});const o=await this.findViewBySelectors(t,e);if(o.success)return void n({success:!0,type:o.type,value:o.value,index:o.index,waitTime:i});setTimeout(s,200)}catch(t){n({success:!1,error:t.message})}};s()}))}async performExtractAction(t,e,a){try{const{selector:r,selectorType:n}=a,s=e.type||"text",i=e.extractConfig||{};switch(s){case"smart":return await this.performSmartExtraction(t,r,n);case"text":return await this.performTextExtraction(t,r,n);case"image_url":return await this.performImageUrlExtraction(t,r,n,i);case"image_background":return await this.performImageBackgroundExtraction(t,r,n,i);case"link_url":return await this.performLinkUrlExtraction(t,r,n,i);default:throw new Error(`Unsupported extract type: ${s}`)}}catch(t){return{success:!1,error:t.message}}}async performClickAction(t,e,a){try{const{selector:e,selectorType:r}=a,n=await this.clickElement(t,e,r,{enabled:!0,duration:this.config?.clickHighlightDuration||2e3});return n.success?{success:!0,value:"clicked",action:"click"}:{success:!1,error:n.error||"Click failed"}}catch(t){return{success:!1,error:t.message}}}async performSmartExtraction(t,e,a){try{const r=await chrome.scripting.executeScript({target:{tabId:t},func:o,args:[e,a,!0]}),n=r[0]?.result;return n&&n.success?{success:!0,columns:n.columns||[],item:n.item||{}}:{success:!1,error:n?.error||"Smart extraction failed"}}catch(t){return{success:!1,error:t.message}}}async performTextExtraction(t,e,a){try{const r=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e){const a=((t,e)=>{if("selector"===e)return document.querySelector(t);if("xpath"===e){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!a)return{success:!1,error:"Element not found"};return{success:!0,value:a.textContent?.trim()||a.innerText?.trim()||""}},args:[e,a]}),n=r[0]?.result;return n||{success:!1,error:"No result from text extraction"}}catch(t){return{success:!1,error:t.message}}}async performImageUrlExtraction(t,e,a,r){try{const n=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a){const r=((t,e)=>{if("selector"===e)return document.querySelector(t);if("xpath"===e){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!r)return{success:!1,error:"Element not found"};const n=a?.sourceAttribute||"src";let s="";if("img"===r.tagName.toLowerCase())s=r.getAttribute(n)||r.src||"";else{const t=r.querySelector("img");t&&(s=t.getAttribute(n)||t.src||"")}return{success:!0,value:s}},args:[e,a,r]}),s=n[0]?.result;return s||{success:!1,error:"No result from image URL extraction"}}catch(t){return{success:!1,error:t.message}}}async performImageBackgroundExtraction(t,e,a,r){try{const n=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a){const r=((t,e)=>{if("selector"===e)return document.querySelector(t);if("xpath"===e){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!r)return{success:!1,error:"Element not found"};const n=window.getComputedStyle(r).backgroundImage;let s="";if(n&&"none"!==n){const t=n.match(/url\(['"]?([^'"]+)['"]?\)/);t&&(s=t[1])}return{success:!0,value:s}},args:[e,a,r]}),s=n[0]?.result;return s||{success:!1,error:"No result from image background extraction"}}catch(t){return{success:!1,error:t.message}}}async performLinkUrlExtraction(t,e,a,r){try{const n=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a){const r=((t,e)=>{if("selector"===e)return document.querySelector(t);if("xpath"===e){return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}return null})(t,e);if(!r)return{success:!1,error:"Element not found"};const n=a?.sourceAttribute||"href";let s="";if("a"===r.tagName.toLowerCase())s=r.getAttribute(n)||r.href||"";else{const t=r.querySelector("a");t&&(s=t.getAttribute(n)||t.href||"")}return{success:!0,value:s}},args:[e,a,r]}),s=n[0]?.result;return s||{success:!1,error:"No result from link URL extraction"}}catch(t){return{success:!1,error:t.message}}}async extractEmailsFromPage(t,e,a){return this.currentAction.config?.enableSubPageScanning?await this.extractEmailsWithSubPageScanning(t,e,a):await this.extractEmailsFromSinglePage(t,a)}async extractEmailsWithSubPageScanning(t,e,a){const r=this.currentAction.config,n=r.maxDepth||2,s=r.maxLinksPerPage||10,i=!1!==r.stayOnDomain,o=r.subPageLinkSelectors||"a[href]",c=[{url:a,depth:0,parentUrl:null}],l=new Set,u=new Set,d={},h=[];try{const e=i?new URL(a).hostname:null;for(;c.length>0;){const{url:r,depth:i,parentUrl:m}=c.shift();if(l.has(r))continue;if(i>=n)continue;l.add(r);let g=t,p=!1;if(r!==a)try{g=await this.createExtractionTab(r),p=!0;if(!(await this.waitForPageLoad(g,this.config.pageLoadTimeout)).success){p&&await this.closeExtractionTab(g);continue}}catch(t){continue}try{const t=await this.extractEmailsFromSinglePage(g,r);if(t.success&&(t.emails.forEach((t=>u.add(t))),Object.entries(t.emailBreakdown).forEach((([t,e])=>{d[t]=(d[t]||0)+e})),h.push({url:r,depth:i,parentUrl:m,emailCount:t.emails.length,emails:t.emails})),i<n-1){(await this.discoverLinksFromPage(g,o,r,e,s)).forEach((t=>{l.has(t)||c.push({url:t,depth:i+1,parentUrl:r})}))}}finally{p&&await this.closeExtractionTab(g)}this.config.delayBetweenRequests>0&&await this.randomizedDelay(this.config.delayBetweenRequests)}const r=Array.from(u);return this.subPageResults=h,this.totalPagesScanned=l.size,{url:a,emails:r,emailBreakdown:d,success:!0,extractedAt:Date.now(),itemCount:r.length,subPageResults:h,totalPagesScanned:l.size}}catch(t){const e=Array.from(u);return this.subPageResults=h,this.totalPagesScanned=l.size,{url:a,emails:e,emailBreakdown:d,success:!1,error:t.message,extractedAt:Date.now(),itemCount:e.length,subPageResults:h,totalPagesScanned:l.size}}}async discoverLinksFromPage(t,e,a,r,n){try{const s=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e,a,r){const n=new Set;new URL(e);return t.split(",").map((t=>t.trim())).filter((t=>t)).forEach((t=>{try{document.querySelectorAll(t).forEach((t=>{let r=t.getAttribute("href");if(r&&!(r.startsWith("mailto:")||r.startsWith("tel:")||r.startsWith("javascript:")))try{const t=new URL(r,e),s=t.href;if(a&&t.hostname!==a)return;if(s===e||s.startsWith(e+"#"))return;const i=t.pathname.toLowerCase();if([/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar|tar|gz)$/,/\.(jpg|jpeg|png|gif|svg|ico|webp)$/,/\.(mp3|mp4|avi|mov|wmv|flv)$/,/\.(css|js|json|xml)$/].some((t=>t.test(i))))return;n.add(s)}catch(t){return}}))}catch(t){}})),Array.from(n).slice(0,r)},args:[e,a,r,n]});return s[0]?.result||[]}catch(t){return[]}}async extractEmailsFromSinglePage(t,e){try{const a=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e){const a=[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,/\b[A-Za-z0-9._%+-]+\s*@\s*[A-Za-z0-9.-]+\s*\.\s*[A-Z|a-z]{2,}\b/g],r=[/\b[A-Za-z0-9._%+-]+\s*\(at\)\s*[A-Za-z0-9.-]+\s*\.\s*[A-Z|a-z]{2,}\b/gi,/\b[A-Za-z0-9._%+-]+\s*\[at\]\s*[A-Za-z0-9.-]+\s*\.\s*[A-Z|a-z]{2,}\b/gi,/\b[A-Za-z0-9._%+-]+\s+at\s+[A-Za-z0-9.-]+\s+dot\s+[A-Z|a-z]{2,}\b/gi,/\b[A-Za-z0-9._%+-]+\s+AT\s+[A-Za-z0-9.-]+\s+DOT\s+[A-Z|a-z]{2,}\b/gi,/\b[A-Za-z0-9._%+-]+\s*\{at\}\s*[A-Za-z0-9.-]+\s*\{dot\}\s*[A-Z|a-z]{2,}\b/gi,/\b[A-Za-z0-9._%+-]+_at_[A-Za-z0-9.-]+_dot_[A-Z|a-z]{2,}\b/gi];let n=[];t?.emailPatterns&&!t.emailPatterns.includes("standard")&&0!==t.emailPatterns.length||n.push(...a),t?.emailPatterns&&t.emailPatterns.forEach((t=>{try{"obfuscated"===t?n.push(...r):"standard"!==t&&n.push(new RegExp(t,"gi"))}catch(t){}})),t?.emailPatterns&&0!==t.emailPatterns.length||n.push(...r);const s=document.body.innerText||document.body.textContent||"",i=new Set;if(n.forEach((e=>{const a=s.match(e);a&&a.forEach((e=>{let a=e.trim();if(a=a.replace(/\s*\(at\)\s*/gi,"@").replace(/\s*\[at\]\s*/gi,"@").replace(/\s+at\s+/gi,"@").replace(/\s+AT\s+/gi,"@").replace(/\s*\{at\}\s*/gi,"@").replace(/_at_/gi,"@").replace(/\s+dot\s+/gi,".").replace(/\s+DOT\s+/gi,".").replace(/\s*\{dot\}\s*/gi,".").replace(/_dot_/gi,".").replace(/\s+/g,""),!1!==t?.basicValidation){if(!a.includes("@")||!a.split("@")[1]?.includes("."))return;if(!/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$/i.test(a))return}if(!1!==t?.toLowerCase&&(a=a.toLowerCase()),t?.domainFilters&&t.domainFilters.length>0){const e=a.split("@")[1];if(!t.domainFilters.some((t=>e.includes(t.toLowerCase()))))return}i.add(a)}))})),!1!==t?.includeMailtoLinks){document.querySelectorAll('a[href^="mailto:"]').forEach((e=>{let a=e.href.replace("mailto:","").split("?")[0].trim();if(!1!==t?.toLowerCase&&(a=a.toLowerCase()),a&&a.includes("@"))if(t?.domainFilters&&t.domainFilters.length>0){const e=a.split("@")[1];t.domainFilters.some((t=>e.includes(t.toLowerCase())))&&i.add(a)}else i.add(a)}))}const o=Array.from(i),c={};return o.forEach((t=>{const e=t.split("@")[1];e&&(c[e]=(c[e]||0)+1)})),{emails:o,emailBreakdown:c,sourceUrl:e,extractedAt:Date.now()}},args:[this.currentAction.config,e]}),r=a[0]?.result||{emails:[],emailBreakdown:{}};return{url:e,emails:r.emails,emailBreakdown:r.emailBreakdown,success:!0,extractedAt:Date.now(),itemCount:r.emails.length}}catch(t){return{url:e,emails:[],emailBreakdown:{},success:!1,error:t.message,extractedAt:Date.now(),itemCount:0}}}async extractPhonesFromPage(t,e,a){try{const e=await chrome.scripting.executeScript({target:{tabId:t},func:function(t){const e=t?.phonePatterns?.map((t=>new RegExp(t,"g")))||[/\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/g,/\b\(\d{3}\)\s*\d{3}[-.]?\d{4}\b/g,/\b1[-.]?\d{3}[-.]?\d{3}[-.]?\d{4}\b/g,/\b\+\d{1,3}[-.\s]?\d{1,4}[-.\s]?\d{1,4}[-.\s]?\d{1,9}\b/g,/\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/g],a=document.body.innerText||document.body.textContent||"",r=new Set;e.forEach((t=>{const e=a.match(t);e&&e.forEach((t=>{const e=t.trim().replace(/\s+/g," ");e.replace(/\D/g,"").length>=10&&r.add(e)}))}));return document.querySelectorAll('a[href^="tel:"]').forEach((t=>{const e=t.href.replace("tel:","").trim();if(e){e.replace(/\D/g,"").length>=10&&r.add(e)}})),Array.from(r)},args:[this.currentAction.config]}),r=e[0]?.result||[];return{url:a,phones:r,success:!0,extractedAt:Date.now(),itemCount:r.length}}catch(t){return{url:a,phones:[],success:!1,error:t.message,extractedAt:Date.now(),itemCount:0}}}async extractGoogleMapsFromPage(t,e,a){try{const e=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e){const a=t=>{try{const e=document.querySelector(t);return e&&e.textContent?.trim()||""}catch(t){return""}};let r="";const n=['h1[data-attrid="title"]',"h1.DUwDvf","h1.x3AX1-LfntMc-header-title-title",'h1[data-value="Name"]',"h1.qrShPb",'[data-attrid="title"] h1',".x3AX1-LfntMc-header-title-title",".DUwDvf.lfPIob"];for(const t of n)if(r=a(t),r)break;let s="",i="";const o=['.F7nice span[aria-hidden="true"]','.ceNzKf[aria-hidden="true"]',"span.ceNzKf",'[data-value="Rating"] span',".MW4etd"];for(const t of o){const e=a(t);if(e&&e.match(/^\d+(\.\d+)?$/)){s=e;break}}const c=[".F7nice .UY7F9",".RDApEe.YrbPuc",'button[data-value="Reviews"] .UY7F9',".UY7F9"];for(const t of c){const e=a(t);if(e&&e.includes("(")&&e.includes(")")){i=e.replace(/[()]/g,"");break}}let l="";const u=[".DkEaL",'button[data-value="Category"]',".YhemCb",'[data-value="Category"] .YhemCb',".DkEaL.fontBodyMedium"];for(const t of u)if(l=a(t),l&&!l.includes("")&&l.length<100)break;let d="";const h=['button[data-item-id="address"] .Io6YTe','button[data-value="Address"] .Io6YTe','[data-item-id="address"] .Io6YTe',".Io6YTe.fontBodyMedium",'button.CsEnBe[aria-label*="Address"]'];for(const t of h)if(d=a(t),d)break;let m="";const g=['button[data-item-id="phone:tel:"] .Io6YTe','button[data-value="Phone"] .Io6YTe','[data-item-id*="phone"] .Io6YTe','button[aria-label*="phone"] .Io6YTe','a[href^="tel:"]'];for(const t of g)if(t.includes('href^="tel:"')){const e=document.querySelector(t);if(e){m=e.href.replace("tel:","");break}}else if(m=a(t),m)break;let p="";const f=['a[data-item-id="authority"]','a[data-value="Website"]','button[data-item-id*="http"]','a[href^="http"]:not([href*="google"]):not([href*="maps"])'];for(const t of f){const e=document.querySelector(t);if(e&&e.href&&!e.href.includes("google.com")&&!e.href.includes("maps")){p=e.href;break}}if(!p){const t=['a[data-item-id="authority"] .Io6YTe','a[data-value="Website"] .Io6YTe','button[data-item-id*="http"] .Io6YTe'];for(const e of t)if(p=a(e),p&&(p.startsWith("http")||p.includes(".")))break}!p||p.startsWith("http://")||p.startsWith("https://")||!p.includes(".")||p.includes(" ")||p.includes("@")||(p="https://"+p);let y="";const w=[".t39EBf.GUrTXd",'[data-value="Hours"] .t39EBf',".OqCZI .t39EBf",".y0skZc-jyrRxf-eEDwDf .t39EBf"],b=[];for(const t of w){if(document.querySelectorAll(t).forEach((t=>{const e=t.textContent?.trim();e&&e.length>2&&b.push(e)})),b.length>0)break}y=b.join("; ");let A="";try{const t=window.location.href.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);if(t)A=`${t[1]}, ${t[2]}`;else{const t=document.querySelectorAll("script");for(const e of t){const t=(e.textContent||"").match(/\[null,null,(-?\d+\.\d+),(-?\d+\.\d+)\]/);if(t){A=`${t[1]}, ${t[2]}`;break}}}}catch(t){}const T=[];if(t?.extractionOptions?.placeImages)try{const t=["button[data-photo-index] img",".ZKCDEc img",".section-carousel-images img",".gallery img"],e=new Set;for(const a of t)document.querySelectorAll(a).forEach((t=>{t.src&&!t.src.includes("data:")&&t.src.includes("http")&&e.add(t.src)}));T.push(...Array.from(e).slice(0,10))}catch(t){}let E="";const I=[".PYvSYb",".cX2Znh",'[data-attrid="description"]',".section-info-definition"];for(const t of I)if(E=a(t),E&&E.length>10)break;const x=[];if(!1!==t?.extractionOptions?.extractPrices)try{const t=[".section-result-menu-item .fontBodyMedium",".section-result-menu-item-price",".section-result-menu-item-name","[data-value*='price']","[data-value*='menu']",".section-popular-times-container .fontBodyMedium",".price-display",".menu-price",".price-range",".section-result-details .fontBodyMedium","[aria-label*='price']","[aria-label*='$']","span:contains('$')","div:contains('$')"],e=new Set;for(const a of t)try{document.querySelectorAll(a).forEach((t=>{const a=t.textContent?.trim();if(a&&(a.includes("$")||a.match(/\$\d+/)||a.match(/\d+\.\d{2}/)||a.toLowerCase().includes("price"))){const t=a.replace(/\s+/g," ").trim();t.length>1&&t.length<100&&e.add(t)}}))}catch(t){}const a=document.body.innerText||document.body.textContent||"";[/\$\d+(?:\.\d{2})?(?:\s*-\s*\$\d+(?:\.\d{2})?)?/g,/\$\d+(?:\.\d{2})?(?:\s*per\s+\w+)?/g,/\$\d+(?:\.\d{2})?(?:\s*each)?/g,/Price:\s*\$\d+(?:\.\d{2})?/gi,/Starting\s+at\s+\$\d+(?:\.\d{2})?/gi,/From\s+\$\d+(?:\.\d{2})?/gi].forEach((t=>{const r=a.match(t);r&&r.forEach((t=>{const a=t.trim();a.length>1&&a.length<50&&e.add(a)}))})),x.push(...Array.from(e).slice(0,20))}catch(t){}let S="";const C=['.mgr77e[aria-label*="Price"]','[data-value="Price level"]',".section-result-details .section-result-price-range"];for(const t of C){const e=document.querySelector(t);if(e&&(S=e.textContent?.trim()||e.getAttribute("aria-label")||"",S))break}return{name:r,rating:s,ratingCount:i,category:l,address:d,phone:m,website:p,hours:y,coordinates:A,images:T,description:E,prices:x,priceLevel:S,sourceUrl:e,extractedAt:Date.now()}},args:[this.currentAction.config,a]});return{url:a,placeData:e[0]?.result||{},success:!0,extractedAt:Date.now(),itemCount:1}}catch(t){return{url:a,placeData:{},success:!1,error:t.message,extractedAt:Date.now(),itemCount:0}}}async extractTextFromPage(t,e,a){try{const e=await chrome.scripting.executeScript({target:{tabId:t},func:function(t,e){const a=t=>t?t.replace(/\s+/g," ").replace(/\n\s*\n/g,"\n").trim():"";let r=document.title||"";const n=['meta[property="og:title"]','meta[name="twitter:title"]',"h1"];for(const t of n){const e=document.querySelector(t);if(e){const t="META"===e.tagName?e.getAttribute("content"):e.textContent?.trim();if(t&&t.length>r.length){r=t;break}}}let s="";const i=['meta[name="description"]','meta[property="og:description"]','meta[name="twitter:description"]'];for(const t of i){const e=document.querySelector(t);if(e&&(s=e.getAttribute("content")||"",s))break}let o="";const c=["main","article",'[role="main"]',".content",".post-content",".entry-content",".article-content","#content",".main-content"];let l=null;for(const t of c)if(l=document.querySelector(t),l)break;if(l||(l=document.body),l){const t=l.cloneNode(!0),e=["script","style","nav","header","footer",".navigation",".nav",".menu",".sidebar",".ads",".advertisement",".social-share",".comments",".comment",'[class*="ad-"]','[id*="ad-"]','[class*="social"]','[class*="share"]'];if(e.forEach((e=>{t.querySelectorAll(e).forEach((t=>t.remove()))})),o=t.textContent||t.innerText||"",o=a(o),o.length<100&&l!==document.body){const t=document.body.cloneNode(!0);e.forEach((e=>{t.querySelectorAll(e).forEach((t=>t.remove()))})),o=a(t.textContent||t.innerText||"")}}const u=o?o.split(/\s+/).filter((t=>t.length>0)).length:0,d=(()=>{const t={},e=['meta[name="author"]','meta[property="article:author"]','[rel="author"]',".author",".byline",'[class*="author"]'];for(const a of e){const e=document.querySelector(a);if(e&&("META"===e.tagName?t.author=e.getAttribute("content"):t.author=e.textContent?.trim(),t.author))break}const a=['meta[property="article:published_time"]','meta[name="date"]','meta[name="publish_date"]',"time[datetime]",".publish-date",".date",'[class*="date"]'];for(const e of a){const a=document.querySelector(e);if(a&&("META"===a.tagName?t.publishDate=a.getAttribute("content"):"TIME"===a.tagName?t.publishDate=a.getAttribute("datetime")||a.textContent?.trim():t.publishDate=a.textContent?.trim(),t.publishDate))break}return t})();return{title:a(r),description:a(s),content:o,wordCount:u,metadata:d,sourceUrl:e,extractedAt:Date.now()}},args:[this.currentAction.config,a]}),r=e[0]?.result||{title:"",description:"",content:"",wordCount:0,metadata:{}};return{url:a,title:r.title,description:r.description,content:r.content,wordCount:r.wordCount,metadata:r.metadata,success:!0,extractedAt:Date.now(),itemCount:1}}catch(t){return{url:a,title:"",description:"",content:"",wordCount:0,metadata:{},success:!1,error:t.message,extractedAt:Date.now(),itemCount:0}}}async randomizedDelay(t){if(!this.config.enableRandomization||!this.config.randomizeDelays||t<=0)return this.delay(t);const e=this.config.delayRandomizationRange/100,a=2*(Math.random()-.5)*e,r=Math.max(0,t*(1+a)),n=Math.random()*(this.config.maxRandomDelay-this.config.minRandomDelay)+this.config.minRandomDelay,s=Math.round(r+n);return this.delay(s)}async simulateHumanBehavior(t){if(this.config.enableRandomization)try{await chrome.scripting.executeScript({target:{tabId:t},func:function(){const t=()=>{const t=new MouseEvent("mousemove",{view:window,bubbles:!0,cancelable:!0,clientX:Math.random()*window.innerWidth,clientY:Math.random()*window.innerHeight});document.dispatchEvent(t)},e=()=>{const t=100*Math.random()-50;window.scrollBy(0,t),setTimeout((()=>{window.scrollBy(0,.3*-t)}),500*Math.random()+100)};Math.random()>.7&&setTimeout(t,2e3*Math.random()),Math.random()>.8&&setTimeout(e,3e3*Math.random()+1e3)}})}catch(t){}}async applyAntiDetectionMeasures(t){this.config.enableRandomization&&await this.simulateHumanBehavior(t)}}};function b(t){const e=w[t];return e||null}async function A(t,e,a,r="default",n={}){const s=b(r);if(!s)throw new Error(`Automation runner '${r}' not found`);try{"function"==typeof s.setAutomationContext&&s.setAutomationContext(t);return await s.execute(t,e,a,n)}catch(t){throw t}}function T(t,e){return w[t],!(!e.execute||"function"!=typeof e.execute)&&(w[t]=e,!0)}function E(){return Object.keys(w)}},363:(t,e,a)=>{a.r(e),a.d(e,{automationService:()=>l});var r=a(81),n=a(588),s=a(184),i=a(750);const o=new class{constructor(){this.runningAutomations=new Map,this.initialize()}initialize(){}isAutomationRunning(t){return this.runningAutomations.has(t)}getRunningAutomations(){return Array.from(this.runningAutomations.values())}async createTableData(t,e,a=null){try{const r=await s.W.createTable(t,[],{...e,source:"automation",createdAt:Date.now()},a);return s.W.setTableContext(r,e),r}catch(t){throw t}}async createAutomation(t,e=null){try{const a={...t,tableDataId:e,createdAt:Date.now(),updatedAt:Date.now()},r=await i.db.createAutomation(a);if(e){const t=await i.db.getTableData(e);t&&!t.automationId&&await i.db.updateTableData(e,{automationId:r})}return r}catch(t){throw t}}async updateAutomationStatus(t,e,a={}){try{return await i.db.updateAutomation(t,{status:e,...a,updatedAt:Date.now()}),!0}catch(t){return!1}}async completeAutomation(t,e={}){try{const a=this.runningAutomations.get(t)||{};return await this.updateAutomationStatus(t,"completed",{result:e,completedAt:Date.now()}),r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_COMPLETED,{automationId:t,tableDataId:a.tableDataId,status:"completed",success:!0,result:e}),!0}catch(t){return!1}}async failAutomation(t,e="Unknown error"){try{const a=this.runningAutomations.get(t)||{};return await this.updateAutomationStatus(t,"failed",{error:e,completedAt:Date.now()}),r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_ERROR,{automationId:t,tableDataId:a.tableDataId,status:"failed",success:!1,error:e}),!0}catch(t){return!1}}async deleteAutomation(t){try{return await i.db.deleteAutomation(t)}catch(t){return!1}}async getAutomation(t){try{return await i.db.getAutomation(t)}catch(t){return null}}async getAllAutomations(t={},e={}){try{return await i.db.getAllAutomations(t,e)}catch(t){return[]}}async getTableDataForAutomation(t){try{return await i.db.getAllTableData({automationId:t})}catch(t){return[]}}async getAutomationWithTableData(t){try{const e=await this.getAutomation(t);if(!e)return null;const a=await this.getTableDataForAutomation(t);return{...e,tableDatas:a}}catch(t){return null}}};var c=a(705);const l=new class{constructor(){this.isRunning=!1,this.currentTabId=null,this.currentAutomationId=null,this.currentRunnerType=null,this.automationQueue=[],this.runningAutomations=new Map,this.initialize()}initialize(){this.setupEventListeners()}setupEventListeners(){r.eventBus.on(r.EVENT_TYPES.AUTOMATION_START,(t=>{const{automationData:e,onAutomationCreated:a}=t;this.startAutomation(e||t,a)})),r.eventBus.on(r.EVENT_TYPES.AUTOMATION_STOP,(()=>{this.stopAllAutomations()})),r.eventBus.on(r.EVENT_TYPES.AUTOMATION_PROGRESS,this.handleAutomationProgress.bind(this)),r.eventBus.on(r.EVENT_TYPES.AUTOMATION_COMPLETED,this.handleAutomationCompleted.bind(this)),r.eventBus.on(r.EVENT_TYPES.AUTOMATION_ERROR,this.handleAutomationError.bind(this)),r.eventBus.on(r.EVENT_TYPES.AUTOMATION_STOPPED,this.handleAutomationStopped.bind(this))}async getTabUrl(t){try{return(await chrome.tabs.get(t)).url}catch(t){return null}}async getTabInfo(t){try{const e=await chrome.tabs.get(t);return{url:e.url,title:e.title,favIconUrl:e.favIconUrl}}catch(t){return{url:null,title:null,favIconUrl:null}}}async getActiveTabInfo(){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});return t?{url:t.url,title:t.title,favIconUrl:t.favIconUrl}:{url:null,title:null,favIconUrl:null}}catch(t){return{url:null,title:null,favIconUrl:null}}}async handleAutomationProgress(t){const e={...t,automationId:t.automationId||this.currentAutomationId,tableDataId:t.tableDataId||this.currentTableDataId,status:"running"};if(t.lastResult&&t.lastResult.message&&(e.message=t.lastResult.message),this.broadcastEvent(r.EVENT_TYPES.AUTOMATION_PROGRESS,e),this.currentAutomationId)try{await o.updateAutomationStatus(this.currentAutomationId,"running",{progress:e})}catch(t){}}async handleAutomationCompleted(t){const e={...t,automationId:t.automationId||this.currentAutomationId,tableDataId:t.tableDataId,status:"completed",success:!0};if(this.broadcastCompletionEvent(e),this.currentAutomationId){try{await o.completeAutomation(this.currentAutomationId,t.result||{})}catch(t){}this.currentAutomationId=null,this.currentRunnerType=null}}async handleAutomationError(t){const e={...t,automationId:t.automationId||this.currentAutomationId,tableDataId:t.tableDataId,status:"failed",success:!1,error:t.error||"Unknown error"};if(this.broadcastEvent(r.EVENT_TYPES.AUTOMATION_ERROR,e),this.currentAutomationId){try{await o.failAutomation(this.currentAutomationId,e.error)}catch(t){}this.currentAutomationId=null,this.currentRunnerType=null}}async handleAutomationStopped(t){const e={...t,automationId:t.automationId||this.currentAutomationId,tableDataId:t.tableDataId,status:"stopped",success:!0};if(this.broadcastEvent(r.EVENT_TYPES.AUTOMATION_STOPPED,e),this.currentAutomationId){try{await o.updateAutomationStatus(this.currentAutomationId,"stopped",{completedAt:Date.now()})}catch(t){}this.currentAutomationId=null,this.currentRunnerType=null}}broadcastEvent(t,e){chrome.runtime.sendMessage({type:t,data:e}).catch((t=>{!t.message.includes("Could not establish connection")&&t.message.includes("Receiving end does not exist")}))}broadcastCompletionEvent(t){if(this.broadcastEvent(r.EVENT_TYPES.AUTOMATION_COMPLETED,t),this.currentTabId)try{chrome.tabs.sendMessage(this.currentTabId,{type:r.EVENT_TYPES.AUTOMATION_COMPLETED,data:t}).catch((t=>{}))}catch(t){}}async startAutomation(t,e){if(this.isRunning)return{success:!1,message:"Automation already running",status:"error"};try{this.isRunning=!0;const{tabId:a,actions:i,runnerType:c="listExtractor",config:l,tableDataId:u}=t;this.currentTabId=a,this.currentRunnerType=c,t.metadata;const d=(0,n.getAutomationRunner)(c);if(!d)throw new Error(`Automation runner '${c}' not found`);let h,m={url:null,title:null,favIconUrl:null};if(a)m=await this.getTabInfo(a);else{const e=await this.getActiveTabInfo();e.url?m=e:"pageExtractor"===c&&t.metadata?.extractionMetadata?m=t.metadata.extractionMetadata:"pageExtractor"===c&&(m={url:"page-extraction",title:"Page Extraction",favIconUrl:null})}let g,p=u;if(p){if(s.W.setTableContext(p,{}),m.url&&"bulk-extraction"!==m.url){const e=t.metadata?.extractionType;await s.W.updateExtractionMetadata({url:m.url,extractionType:c,specificExtractionType:e,source:"automation",createdAt:Date.now()})}await s.W.clearRows()}else try{const e=t.metadata?.extractionType,a={runnerType:c,specificExtractionType:e};p=await s._.createAutomationTable(m,c,a)}catch(t){}try{const n={type:c,status:"running",config:{tabId:a,actions:i,runnerType:c},metadata:{url:m.url,title:m.title,favicon:m.favIconUrl,timestamp:Date.now(),...t.metadata||{}}};h=await o.createAutomation(n,p),this.currentAutomationId=h,this.currentTableDataId=p,"function"==typeof e&&e(h,p),this.broadcastEvent(r.EVENT_TYPES.AUTOMATION_STARTED,{automationId:h,tableDataId:p,type:c,status:"running",metadata:{url:m.url,title:m.title,favicon:m.favIconUrl,...t.metadata||{}}})}catch(t){throw new Error(`Failed to create automation record: ${t.message}`)}g="metadataExtractor"===c&&l?l:i||[];const f=await d.execute(this.currentAutomationId,a,g,p);return this.isRunning=!1,f&&!1===f.success?(r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_ERROR,{success:!1,error:f.error||"Unknown error",result:f,automationId:this.currentAutomationId,tableDataId:p,status:"failed"}),{success:!1,error:f.error||"Unknown error",result:f,automationId:this.currentAutomationId,tableDataId:p,status:"failed"}):(r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_COMPLETED,{success:!0,result:f,automationId:this.currentAutomationId,tableDataId:p,status:"completed"}),{success:!0,result:f,automationId:this.currentAutomationId,tableDataId:p,status:"completed"})}catch(t){return this.isRunning=!1,r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_ERROR,{success:!1,error:t.message||"Unknown error",automationId:this.currentAutomationId,status:"failed"}),{success:!1,error:t.message||"Unknown error",automationId:this.currentAutomationId,status:"failed"}}}stopAutomation(){if(!this.isRunning)return{success:!0,message:"No automation running",status:"stopped"};try{this.currentTabId&&chrome.tabs.sendMessage(this.currentTabId,{type:"AUTOMATION_STOP"}).catch((t=>{}));const t=this.currentRunnerType||"listExtractor",e=(0,n.getAutomationRunner)(t);return e&&("function"==typeof e.stop?e.stop():"function"==typeof e.cancel&&e.cancel()),this.isRunning=!1,r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_STOPPED,{success:!0,automationId:this.currentAutomationId,status:"stopped"}),{success:!0,automationId:this.currentAutomationId,status:"stopped"}}catch(t){return this.isRunning=!1,r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_ERROR,{success:!1,error:t.message||"Unknown error",automationId:this.currentAutomationId,status:"failed"}),{success:!1,error:t.message||"Unknown error",automationId:this.currentAutomationId,status:"failed"}}}async stopAutomationById(t){try{const e=await o.getAutomation(t);if(!e)throw new Error(`Automation #${t} not found`);return"running"!==e.status?{success:!0,message:`Automation is not running (status: ${e.status})`,status:e.status,automationId:t}:this.currentAutomationId===t&&this.isRunning?this.stopAutomation():(await o.updateAutomationStatus(t,"stopped",{completedAt:Date.now(),stoppedBy:"user"}),r.eventBus.emit(r.EVENT_TYPES.AUTOMATION_STOPPED,{success:!0,automationId:t,status:"stopped"}),{success:!0,automationId:t,status:"stopped",message:"Automation stopped successfully"})}catch(e){try{await o.updateAutomationStatus(t,"failed",{error:e.message,completedAt:Date.now()})}catch(t){}return{success:!1,error:e.message||"Unknown error",automationId:t,status:"failed"}}}async rerunAutomation(t){try{const e=await o.getAutomation(t);if(!e)throw new Error(`Automation #${t} not found`);const a=e.metadata?.url;if(!a)throw new Error("No URL found in the original automation");let r=null,n=!1;const s=(await chrome.tabs.query({})).find((t=>t.url===a));if(s)r=s.id,await chrome.tabs.update(r,{active:!0});else{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t)throw new Error("No active tab available to run automation");if("chrome://newtab/"===t.url||"about:blank"===t.url)r=t.id,n=!0;else{r=(await chrome.tabs.create({url:a,active:!0})).id,n=!1}}let i;try{const r=e.metadata?.title||`Rerun ${Date.now()}`;i=await o.createTableData(r,{url:a,extractionType:e.type,specificExtractionType:e.metadata?.extractionType,source:"automation-rerun",originalAutomationId:t,...e.metadata||{}},t)}catch(t){}const c={tabId:r,actions:e.config.actions,runnerType:e.config.runnerType||e.type,config:e.config,isRerun:!0,originalAutomationId:t,tableDataId:i,metadata:e.metadata};await o.updateAutomationStatus(t,"running"),this.currentAutomationId=t,this.currentTableDataId=i,this.isRunning=!0,n&&(await chrome.tabs.update(r,{url:a}),await new Promise((t=>setTimeout(t,2e3))));const l=await this.executeAutomation(t,c);return this.isRunning=!1,this.currentAutomationId=null,this.currentTableDataId=null,await o.updateAutomationStatus(t,l.status||"completed"),l}catch(e){throw this.isRunning=!1,this.currentAutomationId=null,this.currentTableDataId=null,await o.updateAutomationStatus(t,"failed",{error:e.message}),e}}async executeAutomation(t,e){try{if(!await c.default.ensureHostPermissionsForTab(e.tabId,"scripting"))throw new Error("Host permissions are required to execute automation tasks. Please grant permissions and try again.");e.tableDataId&&s.W.setTableContext(e.tableDataId,{automationId:t,extractionType:e.runnerType});const a=await(0,n.executeRunner)(t,e.tabId,e.actions,e.runnerType,{...e.config,tableDataId:e.tableDataId});return{success:!0,tableDataId:e.tableDataId,...a}}catch(t){return{success:!1,error:t.message,status:"failed",tableDataId:e.tableDataId}}}async createAutomation(t){try{if(t.isRerun&&t.originalAutomationId){const e=await o.getAutomation(t.originalAutomationId);if(e)return e}let e;if(t.tabId)e=await chrome.tabs.get(t.tabId);else{const t=await this.getActiveTabInfo();e={url:t.url||"unknown",title:t.title||`Automation ${Date.now()}`,favIconUrl:t.favIconUrl}}let a=t.tableDataId;if(!a)try{const r=e.title||`Table ${Date.now()}`;a=await o.createTableData(r,{url:e.url,extractionType:t.runnerType||"default",specificExtractionType:t.metadata?.extractionType,source:"automation"})}catch(t){}const r={type:t.runnerType||"default",status:"running",config:{tabId:t.tabId,actions:t.actions,runnerType:t.runnerType,...t.config},metadata:{url:e.url,title:e.title,favicon:e.favIconUrl,timestamp:Date.now(),...t.metadata||{}}},n=await o.createAutomation(r,a);return await o.getAutomation(n)}catch(t){throw t}}async updateAutomationStatus(t,e){try{return await o.updateAutomationStatus(t,e),await o.getAutomation(t)}catch(t){throw t}}async stopAllAutomations(){if(this.isRunning&&this.currentRunnerType){const t=(0,n.getAutomationRunner)(this.currentRunnerType);if(t&&("function"==typeof t.stop?t.stop():"function"==typeof t.cancel&&t.cancel()),this.currentTabId)try{chrome.tabs.sendMessage(this.currentTabId,{type:"AUTOMATION_STOP"}).catch((t=>{}))}catch(t){}this.isRunning=!1}const t=o.getRunningAutomations().map((t=>o.updateAutomationStatus(t.id,"stopped",{completedAt:Date.now()})));await Promise.all(t)}async getAllAutomations(){try{return await o.getAllAutomations()}catch(t){return[]}}async getAutomation(t){try{return await o.getAutomation(t)}catch(t){return null}}async getAutomationWithTableData(t){try{return await o.getAutomationWithTableData(t)}catch(t){return null}}async deleteAutomation(t){try{return await o.deleteAutomation(t)}catch(t){return!1}}}},750:(t,e,a)=>{a.d(e,{db:()=>n});const r={AUTOMATIONS:"automations",TABLE_DATA:"tableData",TABLE_ROWS:"tableRows"};const n=new class{constructor(){this.db=null,this.isInitializing=!1}async ensureConnection(){if(!this.db||!Object.values(r).every((t=>this.db.objectStoreNames.contains(t)))){if(this.isInitializing){let t=0;for(;this.isInitializing&&t<10;)await new Promise((t=>setTimeout(t,100))),t++;if(this.db)return}await this.init()}}async init(){if(!this.isInitializing){this.isInitializing=!0;try{return new Promise(((t,e)=>{const r=indexedDB.open("ultimateWebScraperDB",1);r.onerror=()=>{this.isInitializing=!1,e(r.error)},r.onsuccess=async()=>{const e=null===this.db;if(this.db=r.result,this.isInitializing=!1,e&&"undefined"!=typeof document)try{const{sampleDataInitializer:t}=await a.e(281).then(a.bind(a,281));await t.initializeSampleData()}catch(t){}t(),this.db.onerror=t=>{"ConstraintError"!==t.target.error.name&&(this.db=null)},this.db.onclose=()=>{this.db=null},this.db.onversionchange=()=>{this.db.close(),this.db=null}},r.onupgradeneeded=t=>{const e=t.target.result;this.createObjectStores(e,t.oldVersion)}}))}catch(t){throw this.isInitializing=!1,t}}}createObjectStores(t,e){if(!t.objectStoreNames.contains(r.AUTOMATIONS)){const e=t.createObjectStore(r.AUTOMATIONS,{keyPath:"id",autoIncrement:!0});e.createIndex("status","status",{unique:!1}),e.createIndex("type","type",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("url","metadata.url",{unique:!1}),e.createIndex("type_status",["type","status"],{unique:!1})}if(!t.objectStoreNames.contains(r.TABLE_DATA)){const e=t.createObjectStore(r.TABLE_DATA,{keyPath:"id",autoIncrement:!0});e.createIndex("name","name",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("automationId","automationId",{unique:!1})}if(!t.objectStoreNames.contains(r.TABLE_ROWS)){const e=t.createObjectStore(r.TABLE_ROWS,{keyPath:"id",autoIncrement:!0});e.createIndex("tableDataId","tableDataId",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("extractionType","metadata.extractionType",{unique:!1}),e.createIndex("tableData_dataHash",["tableDataId","dataHash"],{unique:!0})}}async createAutomation(t){await this.ensureConnection();const e={...t,createdAt:Date.now(),updatedAt:Date.now()};return new Promise(((t,a)=>{const n=this.db.transaction([r.AUTOMATIONS],"readwrite").objectStore(r.AUTOMATIONS).add(e);n.onsuccess=()=>{t(n.result)},n.onerror=()=>{a(n.error)}}))}async updateAutomation(t,e){return await this.ensureConnection(),new Promise(((a,n)=>{const s=this.db.transaction([r.AUTOMATIONS],"readwrite").objectStore(r.AUTOMATIONS),i=s.get(t);i.onsuccess=()=>{const r=i.result;if(!r)return void n(new Error(`Automation with ID ${t} not found`));const o={...r,...e,updatedAt:Date.now()},c=s.put(o);c.onsuccess=()=>{a(!0)},c.onerror=()=>{n(c.error)}},i.onerror=()=>{n(i.error)}}))}async getAutomation(t){return await this.ensureConnection(),new Promise(((e,a)=>{const n=this.db.transaction([r.AUTOMATIONS],"readonly").objectStore(r.AUTOMATIONS).get(t);n.onsuccess=()=>{n.result?e(n.result):e(null)},n.onerror=()=>{a(n.error)}}))}async getAllAutomations(t={},e={}){await this.ensureConnection();const{limit:a,newestFirst:n=!0}=e;return new Promise(((e,s)=>{const i=this.db.transaction([r.AUTOMATIONS],"readonly").objectStore(r.AUTOMATIONS);let o;if(t.type&&t.status){const e=i.index("type_status");o=e.getAll([t.type,t.status])}else if(t.type){const e=i.index("type");o=e.getAll(t.type)}else if(t.status){const e=i.index("status");o=e.getAll(t.status)}else if(t.url){const e=i.index("url");o=e.getAll(t.url)}else o=i.getAll();o.onsuccess=()=>{let r=o.result;if(t){if(t.dateFrom){const e=new Date(t.dateFrom).getTime();r=r.filter((t=>t.createdAt>=e))}if(t.dateTo){const e=new Date(t.dateTo).getTime();r=r.filter((t=>t.createdAt<=e))}Object.entries(t).forEach((([t,e])=>{["type","status","url","dateFrom","dateTo"].includes(t)||void 0===e||(r=r.filter((a=>{if(t.includes(".")){const r=t.split(".");let n=a;for(const t of r){if(null==n)return!1;n=n[t]}return n===e}return a[t]===e})))}))}r.sort(((t,e)=>n?e.createdAt-t.createdAt:t.createdAt-e.createdAt)),a&&a>0&&(r=r.slice(0,a)),e(r)},o.onerror=()=>{s(o.error)}}))}async getRecentAutomations(t=10,e=null){const a=e?{type:e}:{};return this.getAllAutomations(a,{limit:t,newestFirst:!0})}async getAutomationStats(){const t=await this.getAllAutomations(),e=await this.getAllTableData(),a={total:t.length,byStatus:{},byType:{},totalTableRows:0,totalTables:e.length,recentActivity:[]};t.forEach((t=>{a.byStatus[t.status]=(a.byStatus[t.status]||0)+1,a.byType[t.type]=(a.byType[t.type]||0)+1}));for(const t of e){const e=await this.getTableRowsCountByTableDataId(t.id);if(a.totalTableRows+=e,t.automationId&&e>0){const r=await this.getAutomation(t.automationId);r&&a.recentActivity.push({automationId:r.id,tableId:t.id,tableName:t.name,type:r.type,url:r.metadata?.url,title:r.metadata?.title||t.name,createdAt:t.createdAt,rowCount:e})}}return a.recentActivity.sort(((t,e)=>e.createdAt-t.createdAt)),a.recentActivity=a.recentActivity.slice(0,10),a}async deleteAutomation(t){return await this.ensureConnection(),new Promise((async(e,a)=>{try{const n=await this.getAllTableData({automationId:t});for(const t of n)await this.deleteTableData(t.id);const s=this.db.transaction([r.AUTOMATIONS],"readwrite"),i=s.objectStore(r.AUTOMATIONS).delete(t);i.onsuccess=()=>{e(!0)},i.onerror=()=>{a(i.error)}}catch(t){a(t)}}))}async createTableData(t){await this.ensureConnection();const e={...t,createdAt:Date.now(),updatedAt:Date.now()};return new Promise(((t,a)=>{const n=this.db.transaction([r.TABLE_DATA],"readwrite").objectStore(r.TABLE_DATA).add(e);n.onsuccess=()=>{t(n.result)},n.onerror=()=>{a(n.error)}}))}async updateTableData(t,e){return await this.ensureConnection(),new Promise(((a,n)=>{const s=this.db.transaction([r.TABLE_DATA],"readwrite").objectStore(r.TABLE_DATA),i=s.get(t);i.onsuccess=()=>{const r=i.result;if(!r)return void n(new Error(`Table data with ID ${t} not found`));const o={...r,...e,updatedAt:Date.now()},c=s.put(o);c.onsuccess=()=>{a(!0)},c.onerror=()=>{n(c.error)}},i.onerror=()=>{n(i.error)}}))}async updateTableColumns(t,e){return await this.ensureConnection(),!(!Array.isArray(e)||0===e.length)&&new Promise(((a,n)=>{const s=this.db.transaction([r.TABLE_DATA],"readwrite").objectStore(r.TABLE_DATA),i=s.get(t);i.onsuccess=()=>{const r=i.result;if(!r)return void n(new Error(`Table data with ID ${t} not found`));let o=e;if(r.columns&&Array.isArray(r.columns)){const t=new Map(r.columns.map((t=>[t.id,t])));e.forEach((e=>{t.set(e.id,e)})),o=Array.from(t.values())}const c={...r,columns:o,updatedAt:Date.now()},l=s.put(c);l.onsuccess=()=>{a(!0)},l.onerror=()=>{n(l.error)}},i.onerror=()=>{n(i.error)}}))}async getTableData(t){return await this.ensureConnection(),new Promise(((e,a)=>{const n=this.db.transaction([r.TABLE_DATA],"readonly").objectStore(r.TABLE_DATA).get(t);n.onsuccess=()=>{n.result?e(n.result):e(null)},n.onerror=()=>{a(n.error)}}))}async getAllTableData(t={},e={}){await this.ensureConnection();const{limit:a,newestFirst:n=!0}=e;return new Promise(((e,s)=>{const i=this.db.transaction([r.TABLE_DATA],"readonly").objectStore(r.TABLE_DATA);let o;if(t.automationId){const e=i.index("automationId");o=e.getAll(t.automationId)}else o=i.getAll();o.onsuccess=()=>{let r=o.result;if(t){if(t.dateFrom){const e=new Date(t.dateFrom).getTime();r=r.filter((t=>t.createdAt>=e))}if(t.dateTo){const e=new Date(t.dateTo).getTime();r=r.filter((t=>t.createdAt<=e))}Object.entries(t).forEach((([t,e])=>{["automationId","dateFrom","dateTo"].includes(t)||void 0===e||(r=r.filter((a=>a[t]===e)))}))}r.sort(((t,e)=>n?e.createdAt-t.createdAt:t.createdAt-e.createdAt)),a&&a>0&&(r=r.slice(0,a)),e(r)},o.onerror=()=>{s(o.error)}}))}async deleteTableData(t){return await this.ensureConnection(),new Promise((async(e,a)=>{try{await this.deleteTableRowsByTableDataId(t);const n=this.db.transaction([r.TABLE_DATA],"readwrite"),s=n.objectStore(r.TABLE_DATA).delete(t);s.onsuccess=()=>{e(!0)},s.onerror=()=>{a(s.error)}}catch(t){a(t)}}))}async storeTableRow(t){await this.ensureConnection();const e={...t,createdAt:Date.now()};return new Promise(((t,a)=>{const n=this.db.transaction([r.TABLE_ROWS],"readwrite").objectStore(r.TABLE_ROWS).add(e);n.onsuccess=()=>{t(n.result)},n.onerror=e=>{n.error&&"ConstraintError"===n.error.name?(e.preventDefault(),t(null)):a(n.error)}}))}async getTableRowsByTableDataId(t,e={}){await this.ensureConnection();const{limit:a,newestFirst:n=!0}=e;return new Promise(((e,s)=>{const i=this.db.transaction([r.TABLE_ROWS],"readonly").objectStore(r.TABLE_ROWS).index("tableDataId").getAll(t);i.onsuccess=()=>{let t=i.result;t.sort(((t,e)=>n?e.createdAt-t.createdAt:t.createdAt-e.createdAt)),a&&a>0&&(t=t.slice(0,a)),e(t)},i.onerror=()=>{s(i.error)}}))}async getTableRowsCountByTableDataId(t){return await this.ensureConnection(),new Promise(((e,a)=>{const n=this.db.transaction([r.TABLE_ROWS],"readonly").objectStore(r.TABLE_ROWS).index("tableDataId").count(t);n.onsuccess=()=>{e(n.result)},n.onerror=()=>{a(n.error)}}))}async getTableColumnsAndRows(t,e={}){await this.ensureConnection();const{limit:a,newestFirst:n=!0,sortById:s=!0}=e;return new Promise(((e,i)=>{const o=this.db.transaction([r.TABLE_DATA,r.TABLE_ROWS],"readonly"),c=o.objectStore(r.TABLE_DATA),l=o.objectStore(r.TABLE_ROWS).index("tableDataId"),u={columns:[],data:[]},d=c.get(t);d.onsuccess=()=>{const r=d.result;r&&r.columns&&(u.columns=r.columns);const o=l.getAll(t);o.onsuccess=()=>{let t=o.result;t.length>0&&(s?t.sort(((t,e)=>t.id-e.id)):void 0!==n&&t.sort(((t,e)=>n?e.createdAt-t.createdAt:t.createdAt-e.createdAt)),a&&a>0&&(t=t.slice(0,a))),u.data=t,e(u)},o.onerror=()=>{i(o.error)}},d.onerror=()=>{i(d.error)},o.onerror=()=>{i(o.error)}}))}async deleteTableRowsByTableDataId(t){return await this.ensureConnection(),new Promise(((e,a)=>{const n=this.db.transaction([r.TABLE_ROWS],"readwrite").objectStore(r.TABLE_ROWS),s=n.index("tableDataId").getAll(t);s.onsuccess=()=>{const t=s.result;let r=0,i=0;0!==t.length?t.forEach((s=>{const o=n.delete(s.id);o.onsuccess=()=>{r++,r+i===t.length&&e(!0)},o.onerror=()=>{i++,r+i===t.length&&(i>0?a(new Error(`Failed to delete ${i}/${t.length} table rows`)):e(!0))}})):e(!0)},s.onerror=()=>{a(s.error)}}))}async exportTableRowsAsCsv(t){const e=await this.getTableRowsByTableDataId(t);if(0===e.length)return"No data available";const a=new Set;e.forEach((t=>{Object.keys(t.data).forEach((t=>a.add(t)))}));const r=Array.from(a);let n=r.join(",")+"\n";return e.forEach((t=>{const e=r.map((e=>{const a=t.data[e];if(null==a)return"";if("string"==typeof a){const t=a.replace(/"/g,'""');return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t}"`:t}return"object"==typeof a?`"${JSON.stringify(a).replace(/"/g,'""')}"`:a}));n+=e.join(",")+"\n"})),n}async updateTableRowData(t,e,a,n){return await this.ensureConnection(),new Promise(((s,i)=>{const o=this.db.transaction([r.TABLE_ROWS],"readwrite").objectStore(r.TABLE_ROWS),c=o.get(e);c.onsuccess=()=>{const r=c.result;if(!r)return void i(new Error(`Table row with ID ${e} not found`));if(r.tableDataId!==t)return void i(new Error("Table row doesn't belong to the specified table data"));r.data||(r.data={});const l=r.data[a];r.data[a]=n,r.metadata||(r.metadata={}),r.metadata.modifications||(r.metadata.modifications=[]),r.metadata.modifications.push({columnId:a,oldValue:l,newValue:n,timestamp:Date.now()}),r.updatedAt=Date.now();const u=o.put(r);u.onsuccess=()=>{s(!0)},u.onerror=()=>{i(u.error)}},c.onerror=()=>{i(c.error)}}))}async removeColumnDataFromRows(t,e){return await this.ensureConnection(),new Promise((async(a,n)=>{try{const s=await this.getTableRowsByTableDataId(t);if(0===s.length)return void a(!0);const i=this.db.transaction([r.TABLE_ROWS],"readwrite").objectStore(r.TABLE_ROWS);let o=0,c=0;s.forEach((t=>{if(t.data&&t.data.hasOwnProperty(e)){delete t.data[e],t.metadata||(t.metadata={}),t.metadata.modifications||(t.metadata.modifications=[]),t.metadata.modifications.push({columnId:e,action:"column_removed",timestamp:Date.now()}),t.updatedAt=Date.now();const r=i.put(t);r.onsuccess=()=>{o++,o+c===s.length&&a(!0)},r.onerror=()=>{c++,o+c===s.length&&(c>0?n(new Error(`Failed to update ${c}/${s.length} rows`)):a(!0))}}else o++,o+c===s.length&&a(!0)}))}catch(t){n(t)}}))}async getAutomationsByTableDataId(t){return await this.ensureConnection(),new Promise((async(e,a)=>{try{const a=await this.getTableData(t);if(!a||!a.automationId)return void e([]);const r=await this.getAutomation(a.automationId);if(!r)return void e([]);e([r])}catch(t){a(t)}}))}async truncateAllTables(){return await this.ensureConnection(),new Promise((async(t,e)=>{try{const e=await this.getAllAutomations(),a=await this.getAllTableData();for(const t of a)await this.deleteTableData(t.id);const n=this.db.transaction([r.AUTOMATIONS],"readwrite").objectStore(r.AUTOMATIONS);let s=0,i=0;if(e.length>0)for(const t of e)try{const e=n.delete(t.id);await new Promise(((t,a)=>{e.onsuccess=()=>{s++,t()},e.onerror=()=>{i++,a(e.error)}}))}catch(t){i++}t(!0)}catch(t){e(t)}}))}async cleanupOldTables(t){return await this.ensureConnection(),new Promise((async(e,a)=>{try{const a=await this.getAllTableData({},{newestFirst:!0});if(a.length>t){const e=a.slice(t);for(const t of e)await this.deleteTableData(t.id)}e(!0)}catch(t){a(t)}}))}async initializeSampleData(){if("undefined"==typeof document)return!1;try{const{sampleDataInitializer:t}=await a.e(281).then(a.bind(a,281));return await t.initializeSampleData(),!0}catch(t){return!1}}async removeSampleData(){if("undefined"==typeof document)return!1;try{const{sampleDataInitializer:t}=await a.e(281).then(a.bind(a,281));return await t.removeSampleData(),!0}catch(t){return!1}}async hasSampleData(){if("undefined"==typeof document)return!1;try{const{sampleDataInitializer:t}=await a.e(281).then(a.bind(a,281));return await t.hasSampleData()}catch(t){return!1}}}},81:(t,e,a)=>{a.r(e),a.d(e,{EVENT_TYPES:()=>s,eventBus:()=>n});class r{constructor(){if(r.instance)return r.instance;this.listeners=new Map,this.isInitialized=!1,r.instance=this}initialize(){this.isInitialized||(this.isInitialized=!0)}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{const a=this.listeners.get(t);a&&(a.delete(e),0===a.size&&this.listeners.delete(t))}}emit(t,e){if(!this.isInitialized)return void setTimeout((()=>this.emit(t,e)),100);const a=this.listeners.get(t);a&&a.forEach((t=>{try{t(e)}catch(t){}}))}}const n=new r,s={HELLO:"HELLO",AUTOMATION_START:"AUTOMATION_START",AUTOMATION_STARTED:"AUTOMATION_STARTED",AUTOMATION_STOP:"AUTOMATION_STOP",AUTOMATION_COMPLETED:"AUTOMATION_COMPLETED",AUTOMATION_ERROR:"AUTOMATION_ERROR",AUTOMATION_STOPPED:"AUTOMATION_STOPPED",AUTOMATION_PROGRESS:"AUTOMATION_PROGRESS",ELEMENT_PICKER_RESULT:"ELEMENT_PICKER_RESULT",ELEMENT_PICKER_START:"ELEMENT_PICKER_START",ELEMENT_PICKER_STOP:"ELEMENT_PICKER_STOP"}},184:(t,e,a)=>{a.d(e,{W:()=>i,_:()=>s});var r=a(750),n=a(17);class s{constructor(){this.batchSize=5,this.pendingItems=[],this.processing=!1,this._currentTableDataId=null,this.extractionMetadata={}}_hashData(t){const e=this._sortObjectKeys(t),a=JSON.stringify(e);let r=0;for(let t=0;t<a.length;t++){r=(r<<5)-r+a.charCodeAt(t),r|=0}return r.toString()}_sortObjectKeys(t){return"object"!=typeof t||null===t?t:Array.isArray(t)?t.map((t=>this._sortObjectKeys(t))):Object.keys(t).sort().reduce(((e,a)=>(e[a]=this._sortObjectKeys(t[a]),e)),{})}static async createQuickExtractionTable(t,e,a=[]){const r=t.title||`Table ${Date.now()}`,n={source:"quick_preview",url:t.url,timestamp:Date.now(),selector:e};a&&a.length>0&&(n.allSelectors=a);return await i.createTable(r,[],n)}static async createAutomationTable(t,e,a={}){const r=t.title||`Table ${Date.now()}`,n={url:t.url,extractionType:e,source:"automation",...a,createdAt:Date.now()};return await i.createTable(r,[],n)}async createTable(t,e=[],a={},n=null){const s={name:t,columns:e,metadata:{...a,createdAt:Date.now()},automationId:n},i=await r.db.createTableData(s);return this._currentTableDataId=i,this.extractionMetadata={...a,startedAt:Date.now()},i}setTableContext(t,e={}){return this._currentTableDataId=t,this.extractionMetadata={...e,startedAt:Date.now()},this}get currentTableDataId(){return this._currentTableDataId}updateExtractionMetadata(t={}){return this._currentTableDataId?(this.extractionMetadata={...this.extractionMetadata,...t,updatedAt:Date.now()},this._currentTableDataId&&r.db.updateTableData(this._currentTableDataId,{metadata:this.extractionMetadata}).catch((t=>{})),this.extractionMetadata):this.extractionMetadata}async addRow(t,e={}){if(!this._currentTableDataId)return null;const a=this._hashData(t),r={tableDataId:this._currentTableDataId,data:t,dataHash:a,metadata:{...e,extractedAt:Date.now(),rowId:(0,n.Ij)()}};return this.pendingItems.push(r),this.pendingItems.length>=this.batchSize&&await this.processPendingItems(),r.metadata.rowId}async addRows(t,e={}){if(!Array.isArray(t)||0===t.length)return[];if(!this._currentTableDataId)return[];const a=[],r=t.map((t=>{const r=(0,n.Ij)();a.push(r);const s=this._hashData(t);return{tableDataId:this._currentTableDataId,data:t,dataHash:s,metadata:{...this.extractionMetadata,...e,extractedAt:Date.now(),rowId:r}}}));return this.pendingItems.push(...r),this.pendingItems.length>=this.batchSize&&await this.processPendingItems(),a}async processPendingItems(){if(!this.processing&&0!==this.pendingItems.length)try{this.processing=!0;const t=this.pendingItems.splice(0,this.batchSize);let e=0,a=0,n=0;for(const s of t)try{null===await r.db.storeTableRow(s)?a++:e++}catch(t){n++}}finally{this.processing=!1,this.pendingItems.length>0&&await this.processPendingItems()}}async flush(){await this.processPendingItems()}async getRows(t={}){return this._currentTableDataId?(await this.processPendingItems(),r.db.getTableRowsByTableDataId(this._currentTableDataId,t)):[]}async getRowCount(){if(!this._currentTableDataId)return 0;return await r.db.getTableRowsCountByTableDataId(this._currentTableDataId)}async clearRows(){return!!this._currentTableDataId&&(this.pendingItems=this.pendingItems.filter((t=>t.tableDataId!==this._currentTableDataId)),r.db.deleteTableRowsByTableDataId(this._currentTableDataId))}async updateTableColumns(t){if(!this._currentTableDataId)return!1;if(!Array.isArray(t)||0===t.length)return!1;try{return await r.db.updateTableColumns(this._currentTableDataId,t),!0}catch(t){return!1}}}const i=new s},17:(t,e,a)=>{function r(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}a.d(e,{Ij:()=>r})},705:(t,e,a)=>{a.d(e,{default:()=>r});const r=class{static async hasHostPermissions(t=["<all_urls>"]){try{const e={origins:Array.isArray(t)?t:[t]};return await chrome.permissions.contains(e)}catch(t){return!1}}static async requestHostPermissions(t=["<all_urls>"]){try{const e={origins:Array.isArray(t)?t:[t]},a=await chrome.permissions.request(e);return a}catch(t){return!1}}static async hasOptionalPermissions(t){try{const e={permissions:Array.isArray(t)?t:[t]};return await chrome.permissions.contains(e)}catch(t){return!1}}static async requestOptionalPermissions(t){try{const e={permissions:Array.isArray(t)?t:[t]},a=await chrome.permissions.request(e);return a}catch(t){return!1}}static async checkPermissionsForOperation(t,e=null){return!["scripting"].includes(t)||await this.hasHostPermissions()}static async checkOptionalPermissionsForOperation(t){const e={downloads:["downloads"],clipboard:["clipboardWrite"]}[t];return!e||await this.hasOptionalPermissions(e)}static async ensureHostPermissions(t,e=null,a=!0){return!!await this.checkPermissionsForOperation(t,e)||!!a&&await this.requestHostPermissions()}static async ensureOptionalPermissions(t,e=!0){if(await this.checkOptionalPermissionsForOperation(t))return!0;if(!e)return!1;const a={downloads:["downloads"],clipboard:["clipboardWrite"]}[t];return!a||await this.requestOptionalPermissions(a)}static async ensureHostPermissionsForTab(t,e,a=!0){return await this.ensureHostPermissions(e,null,a)}static getPermissionRequestMessage(t){const e={scripting:"This extension needs permission to interact with web pages to extract data and perform automation tasks.",downloads:"This extension needs permission to download files to your computer.",clipboard:"This extension needs permission to copy data to your clipboard.",default:"This extension needs additional permissions to function properly on this website."};return e[t]||e.default}static async requestPermissionsWithDialog(t,e=null){this.getPermissionRequestMessage(t);return["scripting"].includes(t)?await this.ensureHostPermissions(t,null,!0):!!["downloads","clipboard"].includes(t)&&await this.ensureOptionalPermissions(t,!0)}static async ensureAllPermissions(t,e=!0){return(await Promise.all(t.map((async t=>["scripting"].includes(t)?await this.ensureHostPermissions(t,null,e):!["downloads","clipboard"].includes(t)||await this.ensureOptionalPermissions(t,e))))).every((t=>!0===t))}}}},r={};function n(t){var e=r[t];if(void 0!==e)return e.exports;var s=r[t]={exports:{}};return a[t](s,s.exports,n),s.exports}n.m=a,n.d=(t,e)=>{for(var a in e)n.o(e,a)&&!n.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},n.f={},n.e=t=>Promise.all(Object.keys(n.f).reduce(((e,a)=>(n.f[a](t,e),e)),[])),n.u=t=>t+".bundle.js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t={},e="ultimate-web-scraper:",n.l=(a,r,s,i)=>{if(t[a])t[a].push(r);else{var o,c;if(void 0!==s)for(var l=document.getElementsByTagName("script"),u=0;u<l.length;u++){var d=l[u];if(d.getAttribute("src")==a||d.getAttribute("data-webpack")==e+s){o=d;break}}o||(c=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,n.nc&&o.setAttribute("nonce",n.nc),o.setAttribute("data-webpack",e+s),o.src=a),t[a]=[r];var h=(e,r)=>{o.onerror=o.onload=null,clearTimeout(m);var n=t[a];if(delete t[a],o.parentNode&&o.parentNode.removeChild(o),n&&n.forEach((t=>t(r))),e)return e(r)},m=setTimeout(h.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=h.bind(null,o.onerror),o.onload=h.bind(null,o.onload),c&&document.head.appendChild(o)}},n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;n.g.importScripts&&(t=n.g.location+"");var e=n.g.document;if(!t&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(t=e.currentScript.src),!t)){var a=e.getElementsByTagName("script");if(a.length)for(var r=a.length-1;r>-1&&(!t||!/^http(s?):/.test(t));)t=a[r--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=t})(),(()=>{var t={471:0};n.f.j=(e,a)=>{var r=n.o(t,e)?t[e]:void 0;if(0!==r)if(r)a.push(r[2]);else{var s=new Promise(((a,n)=>r=t[e]=[a,n]));a.push(r[2]=s);var i=n.p+n.u(e),o=new Error;n.l(i,(a=>{if(n.o(t,e)&&(0!==(r=t[e])&&(t[e]=void 0),r)){var s=a&&("load"===a.type?"missing":a.type),i=a&&a.target&&a.target.src;o.message="Loading chunk "+e+" failed.\n("+s+": "+i+")",o.name="ChunkLoadError",o.type=s,o.request=i,r[1](o)}}),"chunk-"+e,e)}};var e=(e,a)=>{var r,s,[i,o,c]=a,l=0;if(i.some((e=>0!==t[e]))){for(r in o)n.o(o,r)&&(n.m[r]=o[r]);if(c)c(n)}for(e&&e(a);l<i.length;l++)s=i[l],n.o(t,s)&&t[s]&&t[s][0](),t[s]=0},a=self.webpackChunkultimate_web_scraper=self.webpackChunkultimate_web_scraper||[];a.forEach(e.bind(null,0)),a.push=e.bind(null,a.push.bind(a))})();var s=n(750);const{eventBus:i,EVENT_TYPES:o}=n(81);const c=class{constructor(){this.setupMessageListener()}setupMessageListener(){chrome.runtime.onMessage.addListener(((t,e,a)=>this.handleMessage(t,e,a)))}handleMessage(t,e,a){switch(t.type){case"OPEN_SIDE_PANEL":return this.handleOpenSidePanel(e,a);case"SIDEPANEL_READY":case"SIDEPANEL_CLOSING":return this.handleSidePanelStatus(t,a);case"START_AUTOMATION":return this.handleStartAutomation(t,e,a);case"STOP_AUTOMATION":return this.handleStopAutomation(t,e,a);case"STOP_AUTOMATION_BY_ID":return this.handleStopAutomationById(t,e,a);case"RERUN_AUTOMATION":return this.handleRerunAutomation(t,e,a);case"GET_AUTOMATION_RUNNERS":return this.handleGetAutomationRunners(t,a);case"PING_BACKGROUND":return this.handlePingBackground(t,a);case"WAKE_UP_BACKGROUND":return this.handleWakeUpBackground(t,a);case"LICENSE_REGISTERED":return this.handleLicenseRegistered(t,e,a);default:return!1}}handleOpenSidePanel(t,e){return chrome.sidePanel.open({windowId:t.tab.windowId}),e({status:"opening"}),!0}handleSidePanelStatus(t,e){return e({status:"acknowledged"}),!0}handleStartAutomation(t,e,a){const r=t.tabId||(e.tab?e.tab.id:null),s=t.tableDataId||null,i=t.runnerType||null;if(!i)return a({success:!1,error:"No runner type provided"}),!0;if("pageExtractor"!==i&&!r)return a({success:!1,error:"No tab ID provided"}),!0;const{automationService:o}=n(363);return o.startAutomation({tabId:r||null,tableDataId:s,actions:t.actions,runnerType:t.runnerType,config:t.config,metadata:t.metadata},((t,e)=>{a({success:!0,status:"started",automationId:t,tableDataId:e})})).then((t=>{})).catch((t=>{a({success:!1,status:"error",error:t.message||"Unknown error"})})),!0}handleRerunAutomation(t,e,a){if(!t.automationId)return a({success:!1,error:"No automation ID provided"}),!0;try{const{automationService:e}=n(363);let r=!1;const s=setTimeout((()=>{r||(a({success:!0,status:"pending",message:"Automation started but waiting for completion"}),r=!0)}),1e3);return e.rerunAutomation(t.automationId).then((t=>{clearTimeout(s),r||(a({success:!0,status:"completed",result:t,tableDataId:t.tableDataId}),r=!0)})).catch((t=>{clearTimeout(s),r||(a({success:!1,status:"error",error:t.message||"Unknown error"}),r=!0)})),!0}catch(t){return a({success:!1,status:"error",error:"Failed to initiate automation re-run"}),!0}}handleStopAutomation(t,e,a){return i.emit(o.AUTOMATION_STOP),a({success:!0,status:"stopped"}),!0}handleStopAutomationById(t,e,a){if(!t.automationId)return a({success:!1,error:"No automation ID provided"}),!0;try{const{automationService:e}=n(363);return e.stopAutomationById(t.automationId).then((t=>{a({success:!0,status:"stopped"})})).catch((t=>{a({success:!1,status:"error",error:t.message||"Unknown error"})})),!0}catch(t){return a({success:!1,status:"error",error:"Failed to stop automation"}),!0}}handleGetAutomationRunners(t,e){const{getAvailableRunnerTypes:a}=n(588);try{e({success:!0,runners:a()})}catch(t){e({success:!1,error:t.message})}return!0}handlePingBackground(t,e){return e({success:!0,status:"active",timestamp:Date.now()}),!0}handleWakeUpBackground(t,e){return e({success:!0,status:"awake"}),!0}handleLicenseRegistered(t,e,a){return chrome.runtime.sendMessage({type:"BROADCAST_LICENSE_UPDATE",data:{isPro:!0,timestamp:Date.now(),source:t.source||"unknown"}}),a({success:!0,status:"broadcasted"}),!0}};n(363);var l=n(81);chrome.action.onClicked.addListener((async t=>{try{await chrome.sidePanel.open({windowId:t.windowId})}catch(t){}}));const u=async()=>{try{l.eventBus.initialize(),await s.db.init(),new c}catch(t){}};chrome.runtime.onInstalled.addListener((()=>{u()})),u()})();